<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>State Regulation of Genetic Privacy and Law Enforcement</title>
  <!--<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">-->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Forum&family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Hide scrollbar initially */
    .sidebar::-webkit-scrollbar {
      display: none;
    }

    /* Show scrollbar when adjustments are applied */
    .sidebar-container.adjusted .sidebar::-webkit-scrollbar {
      display: auto;
    }

    body,
    html {
      height: 100%;
      margin: 0;
      font-family: "Libre Baskerville", serif;
    }

    label {
      font-family: "Source Sans Pro", sans-serif;
      font-weight: 300;
      font-size: 14px;
    }

    #mapcontainer {
      height: 100vh;
      width: calc(100vw - 350px);
      /* Adjusted width */
      position: absolute;
      right: 0;
      top: 0;
      overflow: hidden;
      background-color: #f4f4f9;
    }

    #map {
      width: inherit;
      height: 100vh;
      /* Set initial height */
      overflow: hidden;
      /* Prevent overflow if needed */
    }

    .sidebar-container {
      display: flex;
      flex-direction: column;
      width: 350px;
      height: 100%;
      position: absolute;
      left: 0;
      top: 0;
      background: white;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    .sidebar {
      flex: 1;
      /* Grow to fill available space */
      overflow-y: auto;
      /* Enable vertical scrolling */
      margin-bottom: 190px;
      /* make margin-bottom the same as the height of the legend */
    }

    .sidebar-header {
      padding: 15px 0 15px 15px;
      background: #003366;
      color: white;
      text-align: left;
      font-size: 16px;
      font-weight: bold;
    }

    .legend,
    .filter-legend {
      z-index: 1;
    }

    p {
      padding: 0 15px;
      font-size: 14px;
      font-family: "Source Sans Pro", sans-serif;
      font-weight: 300;
    }

    .layer-control {
      margin-top: 20px;
      padding-left: 15px;
    }

    .layer-control input {
      margin-right: 5px;
    }

    .layer-control button {
      margin: 10px;
      padding: 5px 10px;
      background-color: white;
      color: black;
      box-shadow: 2px 0 3px rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    #compareButton {
      /* center the button */
      display: block;
      margin: 0 auto;
      padding: 5px 10px;
      background-color: white;
      color: black;
      box-shadow: 2px 0 3px rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .layer-control button:hover,
    #compareButton:hover {
      background-color: #f0f0f0;
      /* very light gray */
    }

    .checkbox-group {
      padding-left: 20px;
      margin-bottom: 10px;
    }

    #tooltip,
    #hovertooltip {
      display: none;
      /* Initially hidden */
    }

    .tooltip,
    .hovertooltip {
      max-width: 350px;
      position: absolute;
      text-align: left;
      padding: 10px;
      font: 12px;
      font-family: "Libre Baskerville", serif;
      background: lightsteelblue;
      border: 1px solid #ccc;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
      z-index: 1000;
      /* Ensure tooltip is above other elements */
      pointer-events: auto;
      /* Ensure the tooltip captures mouse events */
    }

    .tooltip.visible,
    .hovertooltip.visible {
      opacity: 1;
      /* Fully visible */
      display: block;
      /* Use block to show the tooltip */
    }

    .tooltip.hidden,
    .hovertooltip.hidden {
      opacity: 0;
      /* Hide the tooltip */
      pointer-events: none;
      /* Disable mouse events when hidden */
    }

    .tooltip .close {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 16px;
      color: black;
      /* Set "X" color to black */
      background: transparent;
      /* Remove background */
      border: none;
      /* Remove border */
      cursor: pointer;
      /* Show pointer cursor on hover */
      padding: 0;
      /* Remove default padding */
    }

    .tooltip .close:hover {
      color: #333;
      /* Darker color on hover for better visibility */
    }

    .highlighted {
      stroke: yellow;
      stroke-width: 2px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid black;
      padding: 8px;
      text-align: left;
      font-family: "Source Sans Pro", sans-serif;
      font-weight: 300;
      font-size: 13px;
    }

    .collapsible-header-overview,
    .collapsible-header-provisions,
    .collapsible-header-comparison,
    .collapsible-header-regulation,
    .collapsible-header-laws {
      cursor: pointer;
    }

    .arrow-icon {
      display: inline-block;
      width: 20px;
      text-align: center;
    }

    .collapsible-content-overview,
    .collapsible-content-laws {
      display: none;
    }

    .collapsible-content-overview.show,
    .collapsible-content-laws.show {
      display: block;
    }

    .collapsible-content-provisions,
    .collapsible-content-comparison,
    .collapsible-content-regulation {
      display: none;
    }

    /* Modal CSS */
    /* Style for the modal background */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    /* Style for the modal content box */
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding-top: 0px;
      padding-left: 20px;
      padding-bottom: 10px;
      padding-right: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 5px;
    }

    /* Style for the close button */
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    /* Style for the table inside the modal */
    #stateCompTable {
      width: 100%;
      border-collapse: collapse;
    }

    #typeHead,
    #firstStateHead,
    #secondStateHead,
    #Life,
    #Disability,
    #LTC,
    #firstStateLife,
    #secondStateLife,
    #firstStateDisability,
    #secondStateDisability,
    #fistStateLTC,
    #secondStateLTC {
      padding: 8px;
      text-align: left;
    }

    #typeHead,
    #firstStateHead,
    #secondStateHead {
      background-color: #f2f2f2;
    }

    /* Style for the dropdown container */
    .dropdown-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    #titlebar {
      text-align: center;
      padding-top: 0px;
      border-radius: 5px;
      /*box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);*/
    }

    h1 {
      margin: 0;
      padding: 10px;
      padding-bottom: 13px;
      color: black;
      font-size: 24px;
      font-weight: bold;
    }

    h4 {
      font-size: 14px;
    }

    .centered-text {
      max-width: 636px;
      /* Sets the maximum width */
      margin: 0 auto;
      /* Centers the paragraph itself under the h1 */
      text-align: left;
      /* Left-aligns the text within the paragraph */
    }

    /* Bottom right text */
    .bottom-right {
      position: absolute;
      bottom: 10px;
      /* Distance from the bottom */
      right: 10px;
      /* Distance from the right */
      font-style: italic;
      /* To maintain the italic style */
    }

    /* Bulleted List */
    ul {
      list-style-type: disc;
      /* Ensure the bullets are shown */
      padding-left: 10px;
      /* Add a small amount of padding to make space for the bullet */
      margin-left: 0;
      /* Remove default left margin */
    }

    li {
      text-align: left;
      /* Align text to the left */
      margin: 0;
      /* Remove extra margin from the list item */
      padding-left: 0;
      /* Reset any padding from the list items */
    }

    li::marker {
      margin-right: 10px;
      /* Adds a slight space after the bullet */
    }
  </style>
</head>

<body>
  <!--A container to hold the sidebar content-->
  <div class="sidebar-container">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">State Regulation of Genetic Privacy<br>and Law Enforcement</div>
      <div class="sidebar-content">
        <div class="collapsible-overview">
          <div class="collapsible-header-overview">
            <h4 style="padding: 0 15px;"><span class="arrow-icon">&#9660;</span> <!-- Down-facing arrow icon -->How to Use</h4>
          </div>
          <div class="collapsible-content-overview show">
            <p>To filter the map, select your desired combination of genetic privacy regulations. You will notice the map change based on your combination of radio button and checkbox inputs. The scrollable list of linked regulations will also change according to your selections. Press the reset button to return to the general coverage map.</p>
          </div>
        </div>
        <!-- Filter Map by Regulation Type -->
        <div class="collapsible-regulation">
          <div class="collapsible-header-regulation">
            <h4 style="padding: 0 15px;"><span class="arrow-icon">&#9658;</span> <!-- Right-facing arrow icon -->Filter Map by Regulation Type</h4>
          </div>
          <div class="collapsible-content-regulation">
            <div class="layer-control">
              <div>
                <input type="radio" id="companiesLayerToggle" name="layer" value="companies">
                <label for="companiesLayerToggle">Regulation of Consumer Genetics Platforms</label>
                <div id="companiesLayerOptions" class="checkbox-group" style="display: none; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                  <input type="checkbox" id="exante" name="exante" value="exante">
                  <label for="exante">Ex-Ante Supervision of FGG</label>
                  <br>
                  <input type="checkbox" id="individual" name="individual" value="individual">
                  <label for="individual">Control Over Own Genetic Data</label>
                  <br>
                  <input type="checkbox" id="thirdparty" name="thirdparty" value="thirdparty">
                  <label for="thirdparty">Non-Suspect Third Party Protections</label>
                  <br>
                  <input type="checkbox" id="fgg" name="fgg" value="fgg">
                  <label for="fgg">Ensures FGG to Prove Culpability</label>
                  <br>
                  <input type="checkbox" id="consequences" name="consequences" value="consequences">
                  <label for="consequences">Consequences for Violations</label>
                  <br>
                  <input type="checkbox" id="reporting" name="reporting" value="reporting">
                  <label for="reporting">Annual Public Reporting and Review</label>
                </div>
              </div>
              <div>
                <input type="radio" id="lawEnforcementLayerToggle" name="layer" value="lawEnforcement">
                <label for="lawEnforcementLayerToggle">Regulation of Law Enforcement</label>
                <!-- This checkbox is not needed 
                <div id="lawEnforcementLayerOptions" class="checkbox-group" style="display: none; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                  <input type="checkbox" id="regulation" name="regulation" value="regulation">
                  <label for="regulation">Direct Regulation of Law Enforcement</label>
                </div> -->
              </div>
              <!--<button id="filterButton">Filter</button>-->
              <button id="resetButton">Reset</button>
            </div>
          </div>
        </div>
        <!-- Filter Map by Regulation Type END -->

        <!-- STATE LAW COMPARISON START -->
        <div class="collapsible-comparison">
          <div class="collapsible-header-comparison">
            <h4 style="padding: 0 15px;"><span class="arrow-icon">&#9658;</span> <!-- Right-facing arrow icon -->Compare State Laws</h4>
          </div>
          <div class="collapsible-content-comparison">
            <p>To compare the legal coverage between two states, select the two states you want to compare from the dropdown menus. Click the "Compare" button and a table will display showing the key legal differences.</p>
            <!-- Dropdown menus for selecting states -->
            <div class="dropdown-container">
              <select id="firstStateDropdown">
                <!-- Populate with US states -->
              </select>
              <select id="secondStateDropdown">
                <!-- Populate with US states -->
              </select>
            </div>
            <!-- Trigger/Open The Modal -->
            <button id="compareButton">Compare</button>
          </div>
        </div>

        <!-- The Modal -->
        <div id="myModal" class="modal">
          <div class="modal-content">
            <span class="close">&times;</span>
            <h2>State Comparison</h2>
            <table id="stateCompTable">
              <thead>
                <tr>
                  <th id="typeHead">Type</th>
                  <th id="firstStateHead">None selected</th>
                  <th id="secondStateHead">None selected</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="exante">Ex-Ante Supervision</td>
                  <td id="firstStateExante"></td>
                  <td id="secondStateExante"></td>
                </tr>
                <tr>
                  <td id="individual">Individual Control</td>
                  <td id="firstStateIndividual"></td>
                  <td id="secondStateIndividual"></td>
                </tr>
                <tr>
                  <td id="thirdparty">Third Party Protections</td>
                  <td id="firstStateThirdparty"></td>
                  <td id="secondStateThirdparty"></td>
                </tr>
                <tr>
                  <td id="fgg">FGG Ensured</td>
                  <td id="firstStateFgg"></td>
                  <td id="secondStateFgg"></td>
                </tr>
                <tr>
                  <td id="consequences">Violation Consequences</td>
                  <td id="firstStateConsequences"></td>
                  <td id="secondStateConsequences"></td>
                </tr>
                <tr>
                  <td id="reporting">Reporting/Review</td>
                  <td id="firstStateReporting"></td>
                  <td id="secondStateReporting"></td>
                </tr>
                <tr>
                  <td id="regulation">Law Enforcement Regulation</td>
                  <td id="firstStateRegulation"></td>
                  <td id="secondStateRegulation"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- STATE LAW COMPARISON END -->

        <div class="collapsible-laws">
          <div class="collapsible-header-laws">
            <h4 style="padding: 0 15px;"><span class="arrow-icon">&#9660;</span> <!-- Down-facing arrow icon -->Read the State-by-State Laws</h4>
          </div>
          <div class="collapsible-content-laws show">
            <div id="stateDetails" style="padding: 15px;"></div>
          </div>
        </div>

      </div>
    </div>

    <div id="legend" style="position: absolute; left: 20px; bottom: 20px; background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
      <h4 style="margin-top: 0; margin-bottom: 5px;">Existence of Legal Coverage</h4>
      <div>
        <!-- Display "patterns/lines-d-02.png" for the case of "Companies" coverage-->
        <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
          <span style="display: inline-block; width: 20px; height: 20px; background-color: rgb(173, 216, 230); background-image: url('patterns/lines-d-02.png'); background-size: 20px 20px; background-repeat: repeat; margin-right: 5px;"></span> Regulates Companies
        </div>
        <!-- Display "patterns/lines-d-05.png" for the case of "Law Enforcement" coverage-->
        <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
          <span style="display: inline-block; width: 20px; height: 20px; background-color: rgb(173, 216, 230); background-image: url('patterns/lines-d-05.png'); background-size: 20px 20px; background-repeat: repeat; margin-right: 5px;"></span> Regulates Law Enforcement
        </div>
        <!-- Display "lightblue" for the case of coverage-->
        <!--<div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
          <span style="display: inline-block; width: 20px; height: 20px; background-color: lightblue; margin-right: 5px;"></span> Present
        </div>-->
        <!-- Display "gray" for the case of no coverage-->
        <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
          <span style="display: inline-block; width: 20px; height: 20px; background-color: rgb(251,247,245); margin-right: 5px;"></span> Absent
        </div>

      </div>
    </div>

    <div id="platform-legend" style="position: absolute; left: 20px; bottom: 20px; background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
      <h4 style="margin-top: 0; margin-bottom: 5px;">Existence of Legal Coverage</h4>
      <div>
        <div style="display: flex; align-items: center; margin-bottom: 0px;">
          <div style="width: 20px; height: 20px; background-color: #D0F4FC; margin-right: 10px;"></div>
          <span style="font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">1 category covered</span>
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 0px;">
          <div style="width: 20px; height: 20px; background-color: #70D9ED; margin-right: 10px;"></div>
          <span style="font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">2</span>
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 0px;">
          <div style="width: 20px; height: 20px; background-color: #08BCDC; margin-right: 10px;"></div>
          <span style="font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">3</span>
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 0px;">
          <div style="width: 20px; height: 20px; background-color: #085997; margin-right: 10px;"></div>
          <span style="font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">4</span>
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 0px;">
          <div style="width: 20px; height: 20px; background-color: #08377F; margin-right: 10px;"></div>
          <span style="font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">5</span>
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 0px;">
          <div style="width: 20px; height: 20px; background-color: #08045C; margin-right: 10px;"></div>
          <span style="font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">6 categories covered</span>
        </div>
      </div>
    </div>

    <div id="enforcement-legend" style="position: absolute; left: 20px; bottom: 20px; background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
      <h4 style="margin-top: 0; margin-bottom: 5px;">Existence of Legal Coverage</h4>
      <div>
        <!-- Display "lightblue" for the case of coverage-->
        <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
          <span style="display: inline-block; width: 20px; height: 20px; background-color: lightblue; margin-right: 5px;"></span> Present
        </div>
        <!-- Display "gray" for the case of no coverage-->
        <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
          <span style="display: inline-block; width: 20px; height: 20px; background-color: rgb(251,247,245); margin-right: 5px;"></span> Absent
        </div>
      </div>
    </div>
  </div>

  <div id="mapcontainer">
    <!--A container in the middle of the page to hold the map title-->
    <div id="titlebar">
      <h1 class="dynamictitle">State Regulation of Genetic Privacy and Law Enforcement</h1>
      <!--    
      <p class="centered-text">The United States Genetic Information Nondiscrimination Act (GINA) prevents health insurers and employers from engaging in genetic discrimination. However, the federal law does not cover life, long-term care, and disability insurers. These insurances are regulated at the state level. There is a range of different types of laws that states have adopted in this area. This map charts the different categories of laws in place across the states.</p>
-->
    </div>
    <div id="map">
    </div>
    <p class="bottom-right"><i>Data current as of October 2024</i></p>
  </div>

  <div class="tooltip" id="tooltip"></div>
  <div class="hovertooltip" id="hovertooltip"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js" integrity="sha512-vc58qvvBdrDR4etbxMdlTt4GBQk1qjvyORR2nrsPsFPyrs+/u5c3+1Ct6upOgdZoIl7eq6k3a1UPDSNAQi/32A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.js"></script>

  <script>
    // Adjust the map height on load
    window.onload = function() {
      const titlebarHeight = document.getElementById('titlebar').offsetHeight;
      document.getElementById('map').style.height = `calc(100vh - ${titlebarHeight}px)`;
    };

    // Adjust the map height on window resize
    window.onresize = function() {
      const titlebarHeight = document.getElementById('titlebar').offsetHeight;
      document.getElementById('map').style.height = `calc(100vh - ${titlebarHeight}px)`;
    };

    // Hide the filter legends by default
    document.getElementById('platform-legend').style.display = 'none';
    document.getElementById('enforcement-legend').style.display = 'none';

    // Hide all checkbox groups by default
    document.querySelectorAll('.checkbox-group').forEach(group => {
      group.style.display = 'none';
    });

    // Show the corresponding checkbox group when a radio button is clicked
    document.querySelectorAll('input[name="layer"]').forEach(radio => {
      radio.addEventListener('change', () => {
        document.querySelectorAll('.checkbox-group').forEach(group => {
          group.style.display = 'none';
        });

        const selectedLayer = radio.value;
        const checkboxGroup = document.getElementById(selectedLayer + 'LayerOptions');
        if (checkboxGroup) {
          checkboxGroup.style.display = 'block';
        }
      });
    });

    // Ensure radio buttons are unchecked on page reload
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
      });
    });

    // Ensure that all checkbox inputs are unchecked on page reload
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
    });

    // Event listener for the "Reset" button
    document.getElementById('resetButton').addEventListener('click', function() {
      // Reload the page
      location.reload();
    });

    // Whenever a radio button is clicked, uncheck all checkboxes
    document.querySelectorAll('input[name="layer"]').forEach(radio => {
      radio.addEventListener('change', () => {
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.checked = false;
        });
      });
    });

    // Get the height of the titlebar div
    const titlebarHeight = document.getElementById('titlebar').offsetHeight;

    // Define the width and height for the SVG
    const width = window.innerWidth * 0.75;
    const height = window.innerHeight;

    // Create the SVG
    const svg = d3.select("#map")
      .append("svg")
      .attr("width", "100%")
      .attr("height", "100%")
      .attr("viewBox", `0 0 ${width} ${height}`); // Optional: Use viewBox to control scaling

    // Define the projection
    const projection = d3.geoAlbersUsa()
      .translate([width / 2, (height / 2)])
      .scale(1000)

    // Define the path
    const path = d3.geoPath(projection);

    // Create a tooltip
    const tooltip = d3.select("#tooltip");
    // Create a hovertooltip
    const hovertooltip = d3.select("#hovertooltip");

    // Universal groupings based on radio group
    // Define the array of companies values
    const companiesValues = ['exante', 'individual', 'thirdparty', 'fgg', 'consequences', 'reporting'];
    // Define the array of law enforcement values
    const lawEnforcementValues = ['regulation'];

    // Load the data
    Promise.all([
      d3.csv("data/IGG_laws.csv"),
      d3.json("data/states-10m.json")
    ]).then(makeMap).catch(error => console.error('Error loading data:', error));

    // Define an empty object to store the state groups
    let stateGroups = {};

    // Define the function to make the map
    function makeMap([dnaLaw, states]) {

      // Store the data in a global variable
      stateGroups = {
        coverageGroup: svg.append("g").attr("id", "coverageLayer"),
        filterGroup: svg.append("g").attr("id", "filterLayer"),
      };

      // Define the pattern and add it to the SVG
      svg.append("defs")
        .append("pattern")
        .attr("id", "crosshatch-pattern-right")
        .attr("patternUnits", "userSpaceOnUse")
        .attr("width", 15)
        .attr("height", 15)
        .append("image")
        .attr("href", "patterns/lines-d-02.png") // Make sure the path is correct
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", 15)
        .attr("height", 15);

      // Define the pattern and add it to the SVG
      svg.append("defs")
        .append("pattern")
        .attr("id", "crosshatch-pattern-left")
        .attr("patternUnits", "userSpaceOnUse")
        .attr("width", 15)
        .attr("height", 15)
        .append("image")
        .attr("href", "patterns/lines-d-05.png") // Make sure the path is correct
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", 15)
        .attr("height", 15);

      // Define the pattern and add it to the SVG
      svg.append("defs")
        .append("pattern")
        .attr("id", "crosshatch-pattern-cross")
        .attr("patternUnits", "userSpaceOnUse")
        .attr("width", 15)
        .attr("height", 15)
        .append("image")
        .attr("href", "patterns/lines-d-25.png") // Make sure the path is correct
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", 15)
        .attr("height", 15);

      // Define the zoom behavior
      const zoom = d3.zoom().scaleExtent([0, 8]).on("zoom", zoomed);
      // Call the zoom behavior on the SVG
      svg.call(zoom);

      // Define the zoomed function
      function zoomed(event) {
        svg.selectAll("g").attr("transform", event.transform);
      }

      // Get the bounds of the map
      const bounds = path.bounds(topojson.feature(states, states.objects.states));

      // Calculate the initial scale
      const initialScale = Math.min(width / (bounds[1][0] - bounds[0][0]), height / (bounds[1][1] - bounds[0][1])) * 0.9;
      // Call the zoom behavior on the SVG
      svg.call(zoom.transform, d3.zoomIdentity.translate(width / 2, height / 2).scale(initialScale).translate(-width / 2, -height / 2));

      // Group the data by state to map the coverage
      const groupedData = groupAndCountEntriesForStates(dnaLaw);

      // Draw the initial map
      drawCoverageLayer(stateGroups.coverageGroup, states, groupedData);

      // Populate the sidebar with all state details
      populateStateDetails(groupedData);

      // Define an empty array to store the filtered data
      let filteredData = [];

      // Listen for a click on a radio button
      document.querySelectorAll('input[name="layer"]').forEach(radio => {
        radio.addEventListener('click', function() {
          // Remove the legend
          document.getElementById('legend').style.display = 'none';
          // Define an empty array to store the sidebar filters
          let sidebarFilters = [];
          // Clear the filteredData array
          filteredData.length = 0;
          // If the radio button value is 'companies', for every value in the companiesValues array, if any groupedData[value] is true, return the groupedData object in a new array
          if (radio.value === 'companies') {
            // Show the platform-legend
            document.getElementById('platform-legend').style.display = 'block';
            // Hide the enforcement-legend
            document.getElementById('enforcement-legend').style.display = 'none';
            // Change the map title
            document.querySelector('.dynamictitle').textContent = 'State Laws Regulating Consumer Genetics Platforms';
            // For every value in the companiesValues array...
            companiesValues.forEach(value => {
              // For every object in the groupedData array...
              groupedData.forEach(data => {
                // If any data[value] is true...
                if (data[value]) {
                  // Add each data object to the filteredData array, but do not push duplicates
                  if (!filteredData.includes(data)) {
                    filteredData.push(data);
                  }
                }
              });
            });
            sidebarFilters = companiesValues;
          } // If the radio button value is 'lawEnforcement', for every value in the lawEnforcementValues array, if any groupedData[value] is true, return the groupedData object in a new array
          else if (radio.value === 'lawEnforcement') {
            // Show the enforcement-legend
            document.getElementById('enforcement-legend').style.display = 'block';
            // Hide the platform-legend
            document.getElementById('platform-legend').style.display = 'none';
            // Change the map title
            document.querySelector('.dynamictitle').textContent = 'State Laws Regulating Law Enforcement Directly';
            // For every value in the lawEnforcementValues array...
            lawEnforcementValues.forEach(value => {
              // For every object in the groupedData array...
              groupedData.forEach(data => {
                // If any data[value] is true...
                if (data[value]) {
                  // Add each data object to the filteredData array, but do not push duplicates
                  if (!filteredData.includes(data)) {
                    filteredData.push(data);
                  }
                }
              });
            });
            sidebarFilters = lawEnforcementValues;
          }
          // Now feed the filteredData array to a drawFilteredLayer function
          drawFilteredLayer(stateGroups.filterGroup, states, filteredData, companiesValues);
          // Call the populateStateDetails function to update the sidebar
          populateStateDetails(filteredData, sidebarFilters);
        });
      });

      // Listen for a click on a checkbox
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('click', function() {
          // Clear the filteredData array
          filteredData.length = 0;
          // Make an array of the checked checkboxes
          const checkedCheckboxes = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
          // Also log the radio button value
          const checkedRadio = document.querySelector('input[name="layer"]:checked').value;
          // If checkedCheckboxes is empty...
          if (checkedCheckboxes.length === 0) {
            // For every value in the companiesValues array...
            companiesValues.forEach(value => {
              // For every object in the groupedData array...
              groupedData.forEach(data => {
                // If any data[value] is true...
                if (data[value]) {
                  // Add each data object to the filteredData array, but do not push duplicates
                  if (!filteredData.includes(data)) {
                    filteredData.push(data);
                  }
                }
              });
            });
          } else if (checkedRadio === 'companies') {
            const filteredStateData = groupedData.filter(d => {
              return checkedCheckboxes.every(checkbox => {
                return d[checkbox];
              });
            });
            // Push each object in filteredStateData to the filteredData array   
            filteredStateData.forEach(data => {
              filteredData.push(data);
            });
          };
          // Now feed the filteredData array to a drawFilteredLayer function
          drawFilteredLayer(stateGroups.filterGroup, states, filteredData, checkedCheckboxes);
          // Call the populateStateDetails function to update the sidebar
          populateStateDetails(filteredData, checkedCheckboxes);
        });
      });

      // STATE LAW COMPARISON START
      // List of US states
      const compStates = [
        "None selected", "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut",
        "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa",
        "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan",
        "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire",
        "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio",
        "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "South Dakota",
        "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia",
        "Wisconsin", "Wyoming"
      ];

      // Populate the dropdown menus
      const firstStateDropdown = document.getElementById('firstStateDropdown');
      const secondStateDropdown = document.getElementById('secondStateDropdown');

      compStates.forEach(state => {
        const option1 = document.createElement('option');
        option1.value = state;
        option1.textContent = state;
        firstStateDropdown.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = state;
        option2.textContent = state;
        secondStateDropdown.appendChild(option2);
      });

      // Get the modal
      const modal = document.getElementById("myModal");

      // Get the button that opens the modal
      const btn = document.getElementById("compareButton");

      // Get the <span> element that closes the modal
      const span = document.getElementsByClassName("close")[0];

      // When the user clicks on <span> (x), close the modal
      span.onclick = function() {
        modal.style.display = "none";
      }

      // When the user clicks anywhere outside of the modal, close it
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }

      // Update the table headers when a state is selected
      firstStateDropdown.onchange = function() {
        document.getElementById('firstStateHead').textContent = firstStateDropdown.value;
      }

      secondStateDropdown.onchange = function() {
        // Prevent the user from selecting the same state in both dropdowns
        if (firstStateDropdown.value === secondStateDropdown.value) {
          alert('Please select two different states to compare.');
          secondStateDropdown.value = 'None selected';
        }
        document.getElementById('secondStateHead').textContent = secondStateDropdown.value;
      }

      // When the user clicks the button, open the modal
      btn.onclick = function() {

        // Clear all the cells in the table
        document.getElementById('firstStateExante').textContent = '';
        document.getElementById('firstStateIndividual').textContent = '';
        document.getElementById('firstStateThirdparty').textContent = '';
        document.getElementById('firstStateFgg').textContent = '';
        document.getElementById('firstStateConsequences').textContent = '';
        document.getElementById('firstStateReporting').textContent = '';
        document.getElementById('firstStateRegulation').textContent = '';
        document.getElementById('secondStateExante').textContent = '';
        document.getElementById('secondStateIndividual').textContent = '';
        document.getElementById('secondStateThirdparty').textContent = '';
        document.getElementById('secondStateFgg').textContent = '';
        document.getElementById('secondStateConsequences').textContent = '';
        document.getElementById('secondStateReporting').textContent = '';
        document.getElementById('secondStateRegulation').textContent = '';

        // Open the modal
        modal.style.display = "block";

        // Get the selected states
        const firstState = firstStateDropdown.value;
        const secondState = secondStateDropdown.value;

        // Get the data for the selected states
        const firstStateData = groupedData.find(state => state.name === firstState);
        const secondStateData = groupedData.find(state => state.name === secondState);

        // Update the table headers
        document.getElementById('firstStateHead').textContent = firstState;
        document.getElementById('secondStateHead').textContent = secondState;

        // Initialize the content variables for each category (Set used to remove duplicates)
        let exanteContent = new Set();
        let individualContent = new Set();
        let thirdpartyContent = new Set();
        let fggContent = new Set();
        let consequencesContent = new Set();
        let reportingContent = new Set();
        let regulationContent = new Set();

        // For each code in firstStateData.codes
        firstStateData.codes.forEach(code => {

          // For code.exante === '1'
          if (code.exante === '1') {
            exanteContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.individual === '1'
          if (code.individual === '1') {
            individualContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.thirdparty === '1'
          if (code.thirdparty === '1') {
            thirdpartyContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.fgg === '1'
          if (code.fgg === '1') {
            fggContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.consequences === '1'
          if (code.consequences === '1') {
            consequencesContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.reporting === '1'
          if (code.reporting === '1') {
            reportingContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.regulation === '1'
          if (code.regulation === '1') {
            regulationContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
        });

        // Helper function to update cells with bulleted list or N/A if empty
        const updateCellWithList = (elementId, contentSet) => {
          const cell = document.getElementById(elementId);
          if (contentSet.size > 0) {
            // Start the unordered list (<ul>) and add each entry as a list item (<li>)
            cell.innerHTML = '<ul>' + Array.from(contentSet).map(item => `<li>${item}</li>`).join('') + '</ul>';
          } else {
            cell.innerHTML = 'N/A';
          }
        };

        // Now update the cells for the first state
        updateCellWithList('firstStateExante', exanteContent);
        updateCellWithList('firstStateIndividual', individualContent);
        updateCellWithList('firstStateThirdparty', thirdpartyContent);
        updateCellWithList('firstStateFgg', fggContent);
        updateCellWithList('firstStateConsequences', consequencesContent);
        updateCellWithList('firstStateReporting', reportingContent);
        updateCellWithList('firstStateRegulation', regulationContent);

        // Initialize the content variables for each category for the second state (Set used to remove duplicates)
        let secondStateExanteContent = new Set();
        let secondStateIndividualContent = new Set();
        let secondStateThirdpartyContent = new Set();
        let secondStateFggContent = new Set();
        let secondStateConsequencesContent = new Set();
        let secondStateReportingContent = new Set();
        let secondStateRegulationContent = new Set();

        // For each code in secondStateData.codes
        secondStateData.codes.forEach(code => {

          // For code.exante === '1'
          if (code.exante === '1') {
            secondStateExanteContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.individual === '1'
          if (code.individual === '1') {
            secondStateIndividualContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.thirdparty === '1'
          if (code.thirdparty === '1') {
            secondStateThirdpartyContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.fgg === '1'
          if (code.fgg === '1') {
            secondStateFggContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.consequences === '1'
          if (code.consequences === '1') {
            secondStateConsequencesContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.reporting === '1'
          if (code.reporting === '1') {
            secondStateReportingContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
          // For code.regulation === '1'
          if (code.regulation === '1') {
            secondStateRegulationContent.add(`<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a>`);
          }
        });

        // Now update the cells for the second state
        updateCellWithList('secondStateExante', secondStateExanteContent);
        updateCellWithList('secondStateIndividual', secondStateIndividualContent);
        updateCellWithList('secondStateThirdparty', secondStateThirdpartyContent);
        updateCellWithList('secondStateFgg', secondStateFggContent);
        updateCellWithList('secondStateConsequences', secondStateConsequencesContent);
        updateCellWithList('secondStateReporting', secondStateReportingContent);
        updateCellWithList('secondStateRegulation', secondStateRegulationContent);
      };



    };

    // Define the function to draw the filtered layer
    function drawFilteredLayer(layerGroup, states, data, filters) {

      // Show the filtered layer
      stateGroups.coverageGroup.style("visibility", "hidden");
      stateGroups.filterGroup.style("visibility", "visible");

      // Draw the background paths based on the state shapes
      layerGroup.selectAll("path.background")
        .data(topojson.feature(states, states.objects.states).features)
        .join("path")
        .attr("class", "background")
        .attr("d", path) // Use the path generator directly for the background
        .attr("fill", "lightblue") // Background color
        .attr("opacity", 1); // Optional: make it semi-transparent

      const notStates = ['District of Columbia', 'American Samoa', 'Guam', 'Commonwealth of the Northern Mariana Islands', 'Puerto Rico', 'United States Virgin Islands'];

      // Now, draw the state paths on top of the background
      layerGroup.selectAll("path.state")
        .data(topojson.feature(states, states.objects.states).features)
        .join("path")
        .attr("class", "state")
        .attr("d", path) // Use the same path generator
        .attr("fill", d => {
          // Check if the state is not in the list of notStates
          if (!notStates.includes(d.properties.name)) {

            // Check the radio button value
            const checkedRadio = document.querySelector('input[name="layer"]:checked').value;

            // Try to find the data for this state
            const stateData = data.find(state => state.name === d.properties.name);

            // If stateData is found (not undefined), process it
            if (stateData) {
              let count = 0;
              for (let value of companiesValues) {
                // Your logic to count the cases here
                if (stateData[value]) {
                  count++;
                }
              }
              // Depending on the count, assign a fill color to the state
              let color;
              // If checkedRadio is 'companies'...
              if (checkedRadio === 'companies') {
                // Using the total count, apply the appropriate color
                if (count === 1) {
                  color = "#D0F4FC";
                } else if (count === 2) {
                  color = "#70D9ED";
                } else if (count === 3) {
                  color = "#08BCDC";
                } else if (count === 4) {
                  color = "#085997";
                } else if (count === 5) {
                  color = "#08377F";
                } else if (count === 6) {
                  color = "#08045C";
                } else {
                  // If count is greater than 6, return a default color
                  color = "rgb(251,247,245)"; // or any other fallback color
                }
              } else if (checkedRadio === 'lawEnforcement') {
                // If checkedRadio is 'lawEnforcement', set color to lightblue
                color = "lightblue";
              }
              return color;
            } else {
              // If stateData is not found, return a default color
              return "rgb(251,247,245)"; // or any other fallback color
            }
          } else {
            return "lightblue";
          }
        })
        .attr("stroke", "gray")
        .attr("stroke-width", 0.5)
        .on("mouseover", function(event, d) {
          d3.select(this).classed("highlighted", true).raise();
          // Show a tooltip with the state name and "click for more info" underneath the state name
          const x = event.pageX;
          const y = event.pageY;
          showHoverTooltip(`<div style="font-size: 14px; font-weight: bold;">${d.properties.name}</div><div style="font-size: 12px;">Click for more info</div>`, x, y);
          // Move the hovertooltip as the mouse moves
          d3.select(this).on("mousemove", function(event) {
            const x = event.pageX;
            const y = event.pageY;
            d3.select("#hovertooltip")
              .style("left", `${x + 10}px`)
              .style("top", `${y + 10}px`);
          });
        })
        .on("click", function(event, d) {
          // Define stateName as d.properties.name if it is not in the list of notStates
          const stateName = !notStates.includes(d.properties.name) ? d.properties.name : null;

          // Define stateData as data.find(state => state.name === d.properties.name) if stateName is not null
          const stateData = stateName ? data.find(state => state.name === d.properties.name) : null;

          let selectedFilters = [];

          // If the 'lawEnforcement' radio button is checked, set selectedFilters to ['regulation']
          if (document.querySelector('input[name="layer"]:checked').value === 'lawEnforcement') {
            selectedFilters = ['regulation'];
          } else {
            // Otherwise, get all the filter checkboxes
            selectedFilters = filters.filter(filter => {
              // Check if the checkbox for each filter is checked
              return document.querySelector(`input[name="${filter}"]:checked`);
            });
          }

          // Create the code list with hyperlinks and filtering logic
          let codeList = stateData ? stateData.codes.map(code => {
            // First, check if the code matches the selected filters
            let matchesFilters = selectedFilters.length === 0 || selectedFilters.some(filter => code[filter] === '1');

            // If the code matches any of the selected filters, include it in the list
            if (matchesFilters) {
              // Create an array to store all descriptions for this code
              let entries = [];

              // Show all descriptions for the matching code, regardless of filters
              if (code.exante === '1') entries.push("Ex-Ante Supervision");
              if (code.individual === '1') entries.push("Individual Control");
              if (code.thirdparty === '1') entries.push("Third Party Protections");
              if (code.fgg === '1') entries.push("FGG Ensured");
              if (code.consequences === '1') entries.push("Violation Consequences");
              if (code.reporting === '1') entries.push("Reporting/Review");
              if (code.regulation === '1') entries.push("Law Enforcement Regulation");

              // If there are entries, format the row for the code
              if (entries.length > 0) {
                let entriesText = entries.length > 1 ? entries.join(', ') : entries[0];

                // Conditionally create the row with or without the hyperlink
                const codeContent = code.link && code.link !== "" ?
                  `<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code || 'N/A'}</a>` :
                  code.code || 'N/A';

                // Return the row with the code and associated descriptions
                return `<tr><td>${codeContent}</td><td title="${entriesText}">${entriesText}</td></tr>`;
              }
            }

            // If the code doesn't match any filters, don't include it
            return null;
          }).filter(item => item !== null).join('') : '<tr><td title="N/A">N/A</td><td title="N/A">N/A</td></tr>';

          // Add the table headers
          const tableHeaders = `<thead><tr><th>Laws</th><th>Type</th></tr></thead>`;

          // Create tooltip content with close button
          const tooltipContent = `<div style="font-size: 14px; font-weight: bold;">${stateName}</div><table>${tableHeaders}<tbody>${codeList}</tbody></table><button class="close" id="tooltip-close">&times;</button>`;

          const x = event.pageX;
          const y = event.pageY;

          // Show the tooltip with content
          showTooltip(tooltipContent, x, y);

          // Hide the hovertooltip
          hideHoverTooltip();

          // Prevent click event from bubbling up to the body
          event.stopPropagation();
        })
        .on("mouseout", function() {
          hideHoverTooltip();
          d3.select(this).classed("highlighted", false);
        });
      // Hide tooltip when clicking outside
      d3.select("body").on("click", function() {
        hideTooltip();
      });
    };

    // Define the function to draw the coverage layer
    function drawCoverageLayer(layerGroup, states, data) {

      // Define the color scale
      const colorScale = d3.scaleOrdinal()
        // The scheme will be three colors, "rgb(251,247,245)" for no coverage, crosshatch-pattern-right for companies coverage, and crosshatch-pattern-left for law enforcement coverage
        .domain(['noCoverage', 'companies', 'lawEnforcement', 'both', 'other'])
        .range(['rgb(251,247,245)', 'url(#crosshatch-pattern-right)', 'url(#crosshatch-pattern-left)', 'url(#crosshatch-pattern-cross)', 'lightblue']);

      // Draw the background paths based on the state shapes
      layerGroup.selectAll("path.background")
        .data(topojson.feature(states, states.objects.states).features)
        .join("path")
        .attr("class", "background")
        .attr("d", path) // Use the path generator directly for the background
        .attr("fill", "lightblue") // Background color
        .attr("opacity", 1); // Optional: make it semi-transparent  

      const notStates = ['District of Columbia', 'American Samoa', 'Guam', 'Commonwealth of the Northern Mariana Islands', 'Puerto Rico', 'United States Virgin Islands'];

      // Now, draw the state paths on top of the background
      layerGroup.selectAll("path.state")
        .data(topojson.feature(states, states.objects.states).features)
        .join("path")
        .attr("class", "state")
        .attr("d", path) // Use the same path generator
        .attr("fill", d => {
          // Check if the state is not in the list of notStates
          if (!notStates.includes(d.properties.name)) {
            // Need to define the data
            const stateData = data.find(state => state.name === d.properties.name);
            // For any value in the companiesValues array, if stateData[value] is true AND for any value in the lawEnforcementValues array, if stateData[value] is true, return 'both'
            if (companiesValues.some(value => stateData[value]) && lawEnforcementValues.some(value => stateData[value])) {
              return colorScale('both');
            } // For any value in the companiesValues array, if stateData[value] is true, return 'companies'
            else if (companiesValues.some(value => stateData[value])) {
              return colorScale('companies');
            } // For any value in the lawEnforcementValues array, if stateData[value] is true, return 'lawEnforcement'
            else if (lawEnforcementValues.some(value => stateData[value])) {
              return colorScale('lawEnforcement');
            } // If none of the above conditions are met, but there is a code in stateData.codes[0].code, return 'other'
            else if (stateData.codes[0].code) {
              return colorScale('other');
            } // If none of the above conditions are met, return 'noCoverage'
            else {
              return colorScale('noCoverage');
            }
          }
        })
        .attr("stroke", "gray")
        .attr("stroke-width", 0.5)
        .on("mouseover", function(event, d) {
          d3.select(this).classed("highlighted", true).raise();
          // Show a tooltip with the state name and "click for more info" underneath the state name
          const x = event.pageX;
          const y = event.pageY;
          showHoverTooltip(`<div style="font-size: 14px; font-weight: bold;">${d.properties.name}</div><div style="font-size: 12px;">Click for more info</div>`, x, y);
          // Move the hovertooltip as the mouse moves
          d3.select(this).on("mousemove", function(event) {
            const x = event.pageX;
            const y = event.pageY;
            d3.select("#hovertooltip")
              .style("left", `${x + 10}px`)
              .style("top", `${y + 10}px`);
          });
        })
        .on("click", function(event, d) {
          // Define stateName as d.properties.name if it is not in the list of notStates
          const stateName = !notStates.includes(d.properties.name) ? d.properties.name : null;
          // Define stateData as data.find(state => state.name === d.properties.name) if stateName is not null
          const stateData = stateName ? data.find(state => state.name === d.properties.name) : null;

          // Create the code list with hyperlinks
          const codeList = stateData ? stateData.codes.map(code => {
            let entries = [];

            if (code.exante === '1') entries.push("Ex-Ante Supervision");
            if (code.individual === '1') entries.push("Individual Control");
            if (code.thirdparty === '1') entries.push("Third Party Protections");
            if (code.fgg === '1') entries.push("FGG Ensured");
            if (code.consequences === '1') entries.push("Violation Consequences");
            if (code.reporting === '1') entries.push("Reporting/Review");
            if (code.regulation === '1') entries.push("Law Enforcement Regulation");

            let entriesText = entries.length > 1 ? entries.join(', ') : entries[0] || 'N/A';

            // Conditionally create the row with or without the hyperlink
            const codeContent = code.link && code.link !== "" ?
              `<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code || 'N/A'}</a>` :
              code.code || 'N/A';

            return `<tr><td>${codeContent}</td><td title="${entries.length ? entriesText : 'N/A'}">${entriesText}</td></tr>`;
          }).join('') : '<tr><td title="N/A">N/A</td><td title="N/A">N/A</td></tr>';

          // Add the table headers
          const tableHeaders = `<thead><tr><th>Laws</th><th>Type</th></tr></thead>`;

          // Create tooltip content with close button
          const tooltipContent = `<div style="font-size: 14px; font-weight: bold;">${stateName}</div><table>${tableHeaders}<tbody>${codeList}</tbody></table><button class="close" id="tooltip-close">&times;</button>`;

          const x = event.pageX;
          const y = event.pageY;

          // Show the tooltip with content
          showTooltip(tooltipContent, x, y);

          // Hide the hovertooltip
          hideHoverTooltip();

          // Prevent click event from bubbling up to the body
          event.stopPropagation();
        })
        .on("mouseout", function() {
          hideHoverTooltip();
          d3.select(this).classed("highlighted", false);
        });
      // Hide tooltip when clicking outside
      d3.select("body").on("click", function() {
        hideTooltip();
      });
    }; // End of drawCoverageLayer function

    // Define the function to group data by state
    function groupAndCountEntriesForStates(data) {

      const stateDataMap = {};

      data.forEach(row => {
        const state = row.State;

        // Create an object for the state if it doesn't exist
        if (!stateDataMap[state]) {
          stateDataMap[state] = {
            name: state,
            exante: false,
            individual: false,
            thirdparty: false,
            fgg: false,
            consequences: false,
            reporting: false,
            regulation: false,
            codes: []
          };
        }

        if (row.exante === '1') {
          stateDataMap[state].exante = true;
        }
        if (row.individual === '1') {
          stateDataMap[state].individual = true;
        }
        if (row.thirdparty === '1') {
          stateDataMap[state].thirdparty = true;
        }
        if (row.fgg === '1') {
          stateDataMap[state].fgg = true;
        }
        if (row.consequences === '1') {
          stateDataMap[state].consequences = true;
        }
        if (row.reporting === '1') {
          stateDataMap[state].reporting = true;
        }
        if (row.regulation === '1') {
          stateDataMap[state].regulation = true;
        }

        // Push data to the codes array
        stateDataMap[state].codes.push({
          code: row.Code,
          link: row.Link,
          citation: row.Citation,
          exante: row.exante,
          individual: row.individual,
          thirdparty: row.thirdparty,
          fgg: row.fgg,
          consequences: row.consequences,
          reporting: row.reporting,
          regulation: row.regulation
        });
      });

      const result = Object.values(stateDataMap).map(state => ({
        name: state.name,
        exante: state.exante,
        individual: state.individual,
        thirdparty: state.thirdparty,
        fgg: state.fgg,
        consequences: state.consequences,
        reporting: state.reporting,
        regulation: state.regulation,
        codes: state.codes
      }));

      return result;

    }; // End of groupAndCountEntriesForStates function

    // Define the function to populate the state details
    function populateStateDetails(stateData, filters) {
      const stateDetailsContainer = document.getElementById('stateDetails');
      stateDetailsContainer.innerHTML = ''; // Clear existing content

      stateData.forEach(state => {
        // Create stateElement only once per state
        const stateElement = document.createElement('div');
        stateElement.style.marginBottom = '10px';

        // Add state name only once
        const stateName = document.createElement('div');
        stateName.innerHTML = `<strong style="font-size: 14px;">${state.name}</strong>`;
        stateElement.appendChild(stateName);

        let filteredCodes = state.codes;

        // Check if any checkboxes are checked
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const anyChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);

        // Check if any radio buttons are checked
        const radioButtons = document.querySelectorAll('input[type="radio"]');
        const anyRadioChecked = Array.from(radioButtons).some(radio => radio.checked);

        // If no checkboxes or radio buttons are checked, show all codes
        if (!anyChecked && !anyRadioChecked) {
          filteredCodes = filteredCodes;
        } // Else...
        /*      
        else if (!anyChecked && anyRadioChecked) {
          if (document.querySelector('input[name="layer"]:checked').value === 'companies') {
            filteredCodes = state.codes.filter(code => {
              return companiesValues.some(filter => code[filter] === "1");
            });
          } else if (document.querySelector('input[name="layer"]:checked').value === 'lawEnforcement') {
            filteredCodes = state.codes.filter(code => {
              return lawEnforcementValues.some(filter => code[filter] === "1");
            });
          }
        } // If checkboxes are checked, show codes based on the selected filter values
*/
        else {
          // Filter the codes based on the selected filter values
          filteredCodes = state.codes.filter(code => {
            return filters.some(filter => code[filter] === "1");
          });
        }

        // Initialize a flag to track whether any valid code is found
        let hasValidCode = false;

        // Create the table of codes for the state
        let codeList = filteredCodes.map(code => {
          if (code.code) {
            hasValidCode = true; // Mark that we have a valid code
            let entries = [];
            if (code.exante === '1') entries.push("Ex-Ante Supervision");
            if (code.individual === '1') entries.push("Individual Control");
            if (code.thirdparty === '1') entries.push("Third Party Protections");
            if (code.fgg === '1') entries.push("FGG Ensured");
            if (code.consequences === '1') entries.push("Violation Consequences");
            if (code.reporting === '1') entries.push("Reporting/Review");
            if (code.regulation === '1') entries.push("Law Enforcement Regulation");
            let entriesText = entries.length > 1 ? entries.join(', ') : entries[0] || 'N/A';
            return `<tr><td><a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a></td><td title="${entries.length ? entriesText : 'N/A'}">${entriesText}</td></tr>`;
          }
          return ''; // If code is empty, return an empty string
        }).join('');

        // Only create and append the table if we have a valid code
        if (hasValidCode) {
          // Create the table element and append the code list
          const codeTable = document.createElement('table');
          codeTable.innerHTML = codeList;
          stateElement.appendChild(codeTable);

          // Append the state element to the container
          stateDetailsContainer.appendChild(stateElement);
        }
      });
    }; // End of populateStateDetails function    


    // TOOLTIP CODE
    // Function to show the hover tooltip
    function showHoverTooltip(content, x, y) {
      const hoverTooltip = document.querySelector('#hovertooltip');
      hoverTooltip.innerHTML = content;
      hoverTooltip.style.display = 'block'; // Temporarily set to block

      // Use setTimeout to ensure the hover tooltip is rendered before measuring
      setTimeout(() => {
        const hoverTooltipRect = hoverTooltip.getBoundingClientRect();
        const mapRect = document.querySelector('#map').getBoundingClientRect();

        // Initial position
        let left = x + 5; // Add padding
        let top = y - 28; // Adjust as needed

        // Adjust positions based on hover tooltip and map dimensions
        if (left + hoverTooltipRect.width > mapRect.right) {
          left = mapRect.right - hoverTooltipRect.width - 5; // Add padding
        }
        if (left < mapRect.left) {
          left = mapRect.left + 5; // Add padding
        }
        if (top + hoverTooltipRect.height > mapRect.bottom) {
          top = mapRect.bottom - hoverTooltipRect.height - 5; // Add padding
        }
        if (top < mapRect.top) {
          top = mapRect.top + 5; // Add padding
        }

        // Set the final position
        hoverTooltip.style.left = `${left}px`;
        hoverTooltip.style.top = `${top}px`;

        // Ensure the hover tooltip classes are set correctly
        hoverTooltip.classList.add('visible');
        hoverTooltip.classList.remove('hidden');

      }, 0); // Execute after rendering

      hoverTooltip.onclick = function(event) {
        event.stopPropagation(); // Prevent click event from bubbling up to other elements
      };
    }; // End of showHoverTooltip function

    // Function to show the tooltip
    function showTooltip(content, x, y) {
      const tooltip = document.querySelector('#tooltip');
      tooltip.innerHTML = content;
      tooltip.style.opacity = 1;
      tooltip.style.display = 'block'; // Temporarily set to block

      // Use setTimeout to ensure the tooltip is rendered before measuring
      setTimeout(() => {
        const tooltipRect = tooltip.getBoundingClientRect();
        const mapRect = document.querySelector('#map').getBoundingClientRect();

        // Initial position
        let left = x + 5; // Add padding
        let top = y - 28; // Adjust as needed

        // Adjust positions based on tooltip and map dimensions
        if (left + tooltipRect.width > mapRect.right) {
          left = mapRect.right - tooltipRect.width - 5; // Add padding
        }
        if (left < mapRect.left) {
          left = mapRect.left + 5; // Add padding
        }
        if (top + tooltipRect.height > mapRect.bottom) {
          top = mapRect.bottom - tooltipRect.height - 5; // Add padding
        }
        if (top < mapRect.top) {
          top = mapRect.top + 5; // Add padding
        }

        // Set the final position
        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${top}px`;

        // Ensure the tooltip classes are set correctly
        tooltip.classList.add('visible');
        tooltip.classList.remove('hidden');

        // Close button functionality
        const closeButton = tooltip.querySelector('.close');
        if (closeButton) {
          closeButton.onclick = function(event) {
            event.stopPropagation(); // Prevent the event from bubbling up
            hideTooltip();
          };
        }

      }, 0); // Execute after rendering

      tooltip.onclick = function(event) {
        event.stopPropagation(); // Prevent click event from bubbling up to other elements
      };
    }; // End of showTooltip function

    function hideTooltip() {
      const tooltip = document.querySelector('#tooltip');
      tooltip.style.display = 'none'; // Hide the tooltip
      tooltip.style.opacity = 0; // Fade out if needed
      tooltip.classList.remove('visible');
      tooltip.classList.add('hidden');
    }; // End of hideTooltip function

    function hideHoverTooltip() {
      const hoverTooltip = document.querySelector('#hovertooltip');
      hoverTooltip.style.display = 'none'; // Hide the hover tooltip
      hoverTooltip.classList.remove('visible');
      hoverTooltip.classList.add('hidden');
    }; // End of hideHoverTooltip function   

    // COLLAPSIBLE CONTENT
    // Get the collapsible section, header, and button
    const collapsibleSectionOverview = document.querySelector('.collapsible-overview');
    const collapsibleSectionProvisions = document.querySelector('.collapsible-provisions');
    const collapsibleSectionComparison = document.querySelector('.collapsible-comparison');
    const collapsibleSectionRegulation = document.querySelector('.collapsible-regulation');
    const collapsibleSectionLaws = document.querySelector('.collapsible-laws');
    const collapsibleHeaderOverview = document.querySelector('.collapsible-header-overview');
    const collapsibleHeaderProvisions = document.querySelector('.collapsible-header-provisions');
    const collapsibleHeaderComparison = document.querySelector('.collapsible-header-comparison');
    const collapsibleHeaderRegulation = document.querySelector('.collapsible-header-regulation');
    const collapsibleHeaderLaws = document.querySelector('.collapsible-header-laws');
    const compareButton = document.getElementById('compareButton');

    // Toggle the visibility of the collapsible content when the header is clicked
    collapsibleHeaderOverview.addEventListener('click', function() {
      const content = collapsibleSectionOverview.querySelector('.collapsible-content-overview');
      const arrowIcon = collapsibleHeaderOverview.querySelector('.arrow-icon');
      content.classList.toggle('show');
      if (content.classList.contains('show')) {
        arrowIcon.innerHTML = '&#9660;'; // Down-facing arrow
      } else {
        arrowIcon.innerHTML = '&#9658;'; // Right-facing arrow
      }
    });

    // Toggle the visibility of the collapsible content when the header is clicked
    collapsibleHeaderComparison.addEventListener('click', function() {
      const content = collapsibleSectionComparison.querySelector('.collapsible-content-comparison');
      const arrowIcon = collapsibleHeaderComparison.querySelector('.arrow-icon');
      if (content.style.display === 'block') {
        content.style.display = 'none';
        arrowIcon.innerHTML = '&#9658;'; // Right-facing arrow
      } else {
        content.style.display = 'block';
        arrowIcon.innerHTML = '&#9660;'; // Down-facing arrow
      }
    });

    // Toggle the visibility of the collapsible content when the header is clicked
    collapsibleHeaderRegulation.addEventListener('click', function() {
      const content = collapsibleSectionRegulation.querySelector('.collapsible-content-regulation');
      const arrowIcon = collapsibleHeaderRegulation.querySelector('.arrow-icon');
      if (content.style.display === 'block') {
        content.style.display = 'none';
        arrowIcon.innerHTML = '&#9658;'; // Right-facing arrow
      } else {
        content.style.display = 'block';
        arrowIcon.innerHTML = '&#9660;'; // Down-facing arrow
      }
    });

    // Toggle the visibility of the collapsible content when the header is clicked
    collapsibleHeaderLaws.addEventListener('click', function() {
      const content = collapsibleSectionLaws.querySelector('.collapsible-content-laws');
      const arrowIcon = collapsibleHeaderLaws.querySelector('.arrow-icon');
      content.classList.toggle('show');
      if (content.classList.contains('show')) {
        arrowIcon.innerHTML = '&#9660;'; // Down-facing arrow
      } else {
        arrowIcon.innerHTML = '&#9658;'; // Right-facing arrow
      }
    });

    // Show the content if the button is clicked (for demonstration purposes)
    compareButton.addEventListener('click', function() {
      const content = collapsibleSectionComparison.querySelector('.collapsible-content-comparison');
      const arrowIcon = collapsibleHeaderComparison.querySelector('.arrow-icon');
      content.style.display = 'block';
      arrowIcon.innerHTML = '&#9660;'; // Down-facing arrow
    });
  </script>
</body>

</html>