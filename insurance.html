<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>State Regulation of Genetics and Insurance</title>
        <!--<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">-->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Forum&family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet" />
        <style>
            /* Hide scrollbar initially */
            .sidebar::-webkit-scrollbar {
                display: none;
            }

            /* Show scrollbar when adjustments are applied */
            .sidebar-container.adjusted .sidebar::-webkit-scrollbar {
                display: auto;
            }

            body,
            html {
                height: 100%;
                margin: 0;
                font-family: "Libre Baskerville", serif;
            }

            label {
                font-family: "Source Sans Pro", sans-serif;
                font-weight: 300;
                font-size: 14px;
            }

            #mapcontainer {
                height: 100vh;
                width: calc(100vw - 350px);
                /* Adjusted width */
                position: absolute;
                right: 0;
                top: 0;
                overflow: hidden;
                background-color: #f4f4f9;
            }

            #map {
                width: inherit;
                height: 100vh; /* Set initial height */
                overflow: hidden; /* Prevent overflow if needed */
            }

            .sidebar-container {
                display: flex;
                flex-direction: column;
                width: 350px;
                height: 100%;
                position: absolute;
                left: 0;
                top: 0;
                background: white;
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
                z-index: 100;
            }

            .sidebar {
                flex: 1;
                /* Grow to fill available space */
                overflow-y: auto;
                /* Enable vertical scrolling */
                margin-bottom: 150px;
                /* make margin-bottom the same as the height of the legend */
            }

            .sidebar-header {
                padding: 15px 0 15px 15px;
                background: #640a08;
                color: white;
                text-align: left;
                font-size: 16px;
                font-weight: bold;
            }

            .legend,
            .filter-legend {
                z-index: 1;
            }

            p {
                padding: 0 15px;
                font-size: 14px;
                font-family: "Source Sans Pro", sans-serif;
                font-weight: 300;
            }

            .layer-control {
                margin-top: 20px;
                padding-left: 15px;
            }

            .layer-control input {
                margin-right: 5px;
            }

            .layer-control button {
                margin: 10px;
                padding: 5px 10px;
                background-color: white;
                color: black;
                box-shadow: 2px 0 3px rgba(0, 0, 0, 0.5);
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }

            #compareButton {
                /* center the button */
                display: block;
                margin: 0 auto;
                padding: 5px 10px;
                background-color: white;
                color: black;
                box-shadow: 2px 0 3px rgba(0, 0, 0, 0.5);
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }

            .layer-control button:hover,
            #compareButton:hover {
                background-color: #f0f0f0;
                /* very light gray */
            }

            .checkbox-group {
                padding-left: 20px;
                margin-bottom: 10px;
            }

            #tooltip,
            #hovertooltip {
                display: none;
                /* Initially hidden */
            }

            .tooltip,
            .hovertooltip {
                position: absolute;
                text-align: left;
                padding: 10px;
                font: 12px;
                font-family: "Libre Baskerville", serif;
                background: lightsteelblue;
                border: 1px solid #ccc;
                border-radius: 4px;
                opacity: 0;
                transition: opacity 0.2s ease-in-out;
                z-index: 1000;
                /* Ensure tooltip is above other elements */
                pointer-events: auto;
                /* Ensure the tooltip captures mouse events */
            }

            .tooltip.visible,
            .hovertooltip.visible {
                opacity: 1;
                /* Fully visible */
                display: block;
                /* Use block to show the tooltip */
            }

            .tooltip.hidden,
            .hovertooltip.hidden {
                opacity: 0;
                /* Hide the tooltip */
                pointer-events: none;
                /* Disable mouse events when hidden */
            }

            .tooltip .close {
                position: absolute;
                top: 5px;
                right: 5px;
                font-size: 16px;
                color: black;
                /* Set "X" color to black */
                background: transparent;
                /* Remove background */
                border: none;
                /* Remove border */
                cursor: pointer;
                /* Show pointer cursor on hover */
                padding: 0;
                /* Remove default padding */
            }

            .tooltip .close:hover {
                color: #333;
                /* Darker color on hover for better visibility */
            }

            .highlighted {
                stroke: yellow;
                stroke-width: 2px;
            }

            table {
                border-collapse: collapse;
                width: 100%;
            }

            th,
            td {
                border: 1px solid black;
                padding: 8px;
                text-align: left;
                font-family: "Source Sans Pro", sans-serif;
                font-weight: 300;
                font-size: 13px;
            }

            .collapsible-header-overview,
            .collapsible-header-provisions,
            .collapsible-header-comparison,
            .collapsible-header-regulation,
            .collapsible-header-laws {
                cursor: pointer;
            }

            .arrow-icon {
                display: inline-block;
                width: 20px;
                text-align: center;
            }

            .collapsible-content-overview,
            .collapsible-content-laws {
                display: none;
            }

            .collapsible-content-overview.show,
            .collapsible-content-laws.show {
                display: block;
            }

            .collapsible-content-provisions,
            .collapsible-content-comparison,
            .collapsible-content-regulation {
                display: none;
            }
            .collapsible-content-regulation.show {
                display: block;
            }

            /* Modal CSS */
            /* Style for the modal background */
            .modal {
                display: none;
                position: fixed;
                z-index: 1;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0, 0, 0, 0.5);
            }

            /* Style for the modal content box */
            .modal-content {
                background-color: #fefefe;
                margin: 15% auto;
                padding: 20px; /* Uniform padding on all sides */
                border: 1px solid #888;
                width: 80%;
                max-width: 500px;
                border-radius: 5px;
            }

            .modal-content h2 {
                margin: 0 0 15px 0; /* Add bottom margin to separate from table */
            }

            .modal-content .close {
                margin: 0 0 10px 0; /* Small margin to separate close button from content */
            }

            #stateCompTable {
                margin: 0; /* Ensure table fits snugly within padding */
            }

            /* Style for the close button */
            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }

            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

            /* Style for the table inside the modal */
            #stateCompTable {
                width: 100%;
                border-collapse: collapse;
            }

            #typeHead,
            #firstStateHead,
            #secondStateHead,
            #Life,
            #Disability,
            #LTC,
            #firstStateLife,
            #secondStateLife,
            #firstStateDisability,
            #secondStateDisability,
            #fistStateLTC,
            #secondStateLTC {
                padding: 8px;
                text-align: left;
            }

            #typeHead,
            #firstStateHead,
            #secondStateHead {
                background-color: #f2f2f2;
            }

            /* Style for the dropdown container */
            .dropdown-container {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-bottom: 20px;
            }

            #titlebar {
                text-align: center;
                padding-top: 0px;
                border-radius: 5px;
                /*box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);*/
            }

            h1 {
                margin: 0;
                padding: 10px;
                padding-bottom: 13px;
                color: black;
                font-size: 24px;
                font-weight: bold;
            }

            h4 {
                font-size: 14px;
            }

            .centered-text {
                max-width: 636px; /* Sets the maximum width */
                margin: 0 auto; /* Centers the paragraph itself under the h1 */
                text-align: left; /* Left-aligns the text within the paragraph */
            }

            /* Bottom right text */
            .bottom-right {
                position: absolute;
                bottom: 10px; /* Distance from the bottom */
                right: 10px; /* Distance from the right */
                font-style: italic; /* To maintain the italic style */
            }
        </style>
    </head>

    <body>
        <!--A container to hold the sidebar content-->
        <div class="sidebar-container">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">State Regulation of Genetics and Insurance</div>
                <div class="sidebar-content">
                    <div class="collapsible-overview">
                        <div class="collapsible-header-overview">
                            <h4 style="padding: 0 15px;">
                                <span class="arrow-icon">&#9660;</span>
                                <!-- Down-facing arrow icon -->How to Use
                            </h4>
                        </div>
                        <div class="collapsible-content-overview show">
                            <p>
                                To filter the map, select your desired combination of genetic privacy regulations. You will notice the map change based on your combination of radio button and checkbox inputs. The scrollable list of linked
                                regulations will also change according to your selections. Press the reset button to return to the general coverage map.
                            </p>
                        </div>
                    </div>

                    <!-- Filter Map by Regulation Type -->
                    <div class="collapsible-regulation">
                        <div class="collapsible-header-regulation">
                            <h4 style="padding: 0 15px;">
                                <span class="arrow-icon">▼</span>
                                Filter Map by Regulation Type
                            </h4>
                        </div>
                        <div class="collapsible-content-regulation show">
                            <div class="layer-control">
                                <div>
                                    <input type="radio" id="lifeLayerToggle" name="layer" value="life" />
                                    <label for="lifeLayerToggle">Life Insurance</label>
                                    <div id="lifeLayerOptions" class="checkbox-group" style="display: none; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                                        <input type="checkbox" id="lifeOption2" name="lifeOptions" value="2" />
                                        <label for="lifeOption2">Prohibits use of genetic info</label><br />
                                        <input type="checkbox" id="lifeOption4" name="lifeOptions" value="4" />
                                        <label for="lifeOption4">Bars use of a specific trait</label><br />
                                        <input type="checkbox" id="lifeOption3" name="lifeOptions" value="3" />
                                        <label for="lifeOption3">Allowed if actuarially justified</label><br />
                                        <input type="checkbox" id="lifeOption1" name="lifeOptions" value="1" />
                                        <label for="lifeOption1">Requires informed consent</label><br />
                                        <input type="checkbox" id="lifeOption5" name="lifeOptions" value="5" />
                                        <label for="lifeOption5">Other</label>
                                    </div>
                                </div>
                                <div>
                                    <input type="radio" id="disabilityLayerToggle" name="layer" value="disability" />
                                    <label for="disabilityLayerToggle">Disability Insurance</label>
                                    <div id="disabilityLayerOptions" class="checkbox-group" style="display: none; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                                        <input type="checkbox" id="disabilityOption2" name="disabilityOptions" value="2" />
                                        <label for="disabilityOption2">Prohibits use of genetic info</label><br />
                                        <input type="checkbox" id="disabilityOption4" name="disabilityOptions" value="4" />
                                        <label for="disabilityOption4">Bars use of a specific trait</label><br />
                                        <input type="checkbox" id="disabilityOption3" name="disabilityOptions" value="3" />
                                        <label for="disabilityOption3">Allowed if actuarially justified</label><br />
                                        <input type="checkbox" id="disabilityOption1" name="disabilityOptions" value="1" />
                                        <label for="disabilityOption1">Requires informed consent</label><br />
                                        <input type="checkbox" id="disabilityOption5" name="disabilityOptions" value="5" />
                                        <label for="disabilityOption5">Other</label>
                                    </div>
                                </div>
                                <div>
                                    <input type="radio" id="ltcLayerToggle" name="layer" value="ltc" />
                                    <label for="ltcLayerToggle">Long-Term Care Insurance</label>
                                    <div id="ltcLayerOptions" class="checkbox-group" style="display: none; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                                        <input type="checkbox" id="ltcOption2" name="ltcOptions" value="2" />
                                        <label for="ltcOption2">Prohibits use of genetic info</label><br />
                                        <input type="checkbox" id="ltcOption4" name="ltcOptions" value="4" />
                                        <label for="ltcOption4">Bars use of a specific trait</label><br />
                                        <input type="checkbox" id="ltcOption3" name="ltcOptions" value="3" />
                                        <label for="ltcOption3">Allowed if actuarially justified</label><br />
                                        <input type="checkbox" id="ltcOption1" name="ltcOptions" value="1" />
                                        <label for="ltcOption1">Requires informed consent</label><br />
                                        <input type="checkbox" id="ltcOption5" name="ltcOptions" value="5" />
                                        <label for="ltcOption5">Other</label>
                                    </div>
                                </div>
                                <!--<button id="filterButton">Filter</button>-->
                                <button id="resetButton">Reset</button>
                            </div>
                        </div>
                    </div>

                    <div class="collapsible-provisions">
                        <div class="collapsible-header-provisions">
                            <h4 style="padding: 0 15px;">
                                <span class="arrow-icon">&#9658;</span>
                                <!-- Right-facing arrow icon -->Explore Protective Features
                            </h4>
                        </div>
                        <div class="collapsible-content-provisions">
                            <p>
                                State laws can offer varying levels of protection by utilizing different language and features. <a style="color: #004b9b;" href="protective-features-insurance.html" target="_blank">Click here to learn more.</a>
                            </p>
                        </div>
                    </div>

                    <!-- Filter Map by Regulation Type END -->

                    <!-- STATE LAW COMPARISON START -->
                    <div class="collapsible-comparison">
                        <div class="collapsible-header-comparison">
                            <h4 style="padding: 0 15px;">
                                <span class="arrow-icon">&#9658;</span>
                                <!-- Right-facing arrow icon -->Compare State Laws
                            </h4>
                        </div>
                        <div class="collapsible-content-comparison">
                            <p>To compare the legal coverage between two states, select the two states you want to compare from the dropdown menus. Click the "Compare" button and a table will display showing the key legal differences.</p>
                            <!-- Dropdown menus for selecting states -->
                            <div class="dropdown-container">
                                <select id="firstStateDropdown">
                                    <!-- Populate with US states -->
                                </select>
                                <select id="secondStateDropdown">
                                    <!-- Populate with US states -->
                                </select>
                            </div>
                            <!-- Trigger/Open The Modal -->
                            <button id="compareButton">Compare</button>
                        </div>
                    </div>

                    <!-- The Modal -->
                    <div id="myModal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2>State Comparison</h2>
                            <table id="stateCompTable">
                                <thead>
                                    <tr>
                                        <th id="typeHead">Type</th>
                                        <th id="firstStateHead">None selected</th>
                                        <th id="secondStateHead">None selected</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td id="Life">Life</td>
                                        <td id="firstStateLife"></td>
                                        <td id="secondStateLife"></td>
                                    </tr>
                                    <tr>
                                        <td id="Disability">Disability</td>
                                        <td id="firstStateDisability"></td>
                                        <td id="secondStateDisability"></td>
                                    </tr>
                                    <tr>
                                        <td id="LTC">LTC</td>
                                        <td id="firstStateLTC"></td>
                                        <td id="secondStateLTC"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- STATE LAW COMPARISON END -->

                    <div class="collapsible-laws">
                        <div class="collapsible-header-laws">
                            <h4 style="padding: 0 15px;">
                                <span class="arrow-icon">&#9660;</span>
                                <!-- Down-facing arrow icon -->Read the State-by-State Laws
                            </h4>
                        </div>
                        <div class="collapsible-content-laws show">
                            <div id="stateDetails" style="padding: 15px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="legend" style="position: absolute; left: 20px; bottom: 20px; background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
                <h4 style="margin-top: 0; margin-bottom: 0;">Total Categories Covered</h4>
                <div>
                    <!-- Life -->
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span
                            style="
                                display: inline-block;
                                width: 20px;
                                height: 20px;
                                background-color: rgb(232,176,172);
                                background-image: url('patterns/lines-d-02.png');
                                background-size: 20px 20px;
                                background-repeat: repeat;
                                margin-right: 5px;
                            "
                        ></span>
                        Life Covered
                    </div>
                    <!-- Disability -->
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span
                            style="
                                display: inline-block;
                                width: 20px;
                                height: 20px;
                                background-color: rgb(232,176,172);
                                background-image: url('patterns/lines-d-05.png');
                                background-size: 20px 20px;
                                background-repeat: repeat;
                                margin-right: 5px;
                            "
                        ></span>
                        Disability Covered
                    </div>
                    <!-- LTC -->
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span
                            style="
                                display: inline-block;
                                width: 20px;
                                height: 20px;
                                background-color: rgb(232,176,172);
                                background-image: url('patterns/lines-v-02.png');
                                background-size: 30px 30px;
                                background-repeat: repeat;
                                margin-right: 5px;
                            "
                        ></span>
                        LTC Covered
                    </div>
                    <!-- Life + Disability -->
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span
                            style="
                                display: inline-block;
                                width: 20px;
                                height: 20px;
                                background-color: rgb(232,176,172);
                                background-image: url('patterns/lines-d-25.png');
                                background-size: 20px 20px;
                                background-repeat: repeat;
                                margin-right: 5px;
                            "
                        ></span>
                        Life + Disability Covered
                    </div>
                    <!-- Life + LTC -->
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span
                            style="
                                display: inline-block;
                                width: 20px;
                                height: 20px;
                                background-color: rgb(232,176,172);
                                background-image: url('patterns/lines-dv-22.png');
                                background-size: 20px 20px;
                                background-repeat: repeat;
                                margin-right: 5px;
                            "
                        ></span>
                        Life + LTC Covered
                    </div>
                    <!-- Disability + LTC -->
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span
                            style="
                                display: inline-block;
                                width: 20px;
                                height: 20px;
                                background-color: rgb(232,176,172);
                                background-image: url('patterns/lines-dv-25.png');
                                background-size: 20px 20px;
                                background-repeat: repeat;
                                margin-right: 5px;
                            "
                        ></span>
                        Disability + LTC Covered
                    </div>
                    <!-- Life + Disability + LTC -->
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span
                            style="
                                display: inline-block;
                                width: 20px;
                                height: 20px;
                                background-color: rgb(232,176,172);
                                background-image: url('patterns/lines-dv-all.png');
                                background-size: 20px 20px;
                                background-repeat: repeat;
                                margin-right: 5px;
                            "
                        ></span>
                        Life + Disability + LTC Covered
                    </div>
                    <!-- No Coverage -->
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span style="display: inline-block; width: 20px; height: 20px; background-color: rgb(251,247,245); margin-right: 5px;"></span>
                        Absent
                    </div>
                </div>
            </div>

            <div id="filter-legend" style="position: absolute; left: 20px; bottom: 20px; background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
                <h4 style="margin-top: 0; margin-bottom: 0;">Strength of Coverage</h4>
                <div>
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span style="display: inline-block; width: 20px; height: 20px; background-color: #4A0403; margin-right: 5px;"></span> Prohibits use of genetic info
                    </div>
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span style="display: inline-block; width: 20px; height: 20px; background-color: #8B1A17; margin-right: 5px;"></span> Bars use of a specific trait
                    </div>
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span style="display: inline-block; width: 20px; height: 20px; background-color: #C23B37; margin-right: 5px;"></span> Allowed if actuarially justified
                    </div>
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span style="display: inline-block; width: 20px; height: 20px; background-color: #E8B0AC; margin-right: 5px;"></span> Requires informed consent
                    </div>
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span style="display: inline-block; width: 20px; height: 20px; background-color: #F4D5D3; margin-right: 5px;"></span> Other
                    </div>
                    <div style="display: flex; align-items: center; font-family: Source Sans Pro, sans-serif; font-weight: 300; font-size: 13px;">
                        <span style="display: inline-block; width: 20px; height: 20px; background-color: rgb(251,247,245); margin-right: 5px;"></span> Absent
                    </div>
                </div>
            </div>
        </div>

        <div id="mapcontainer">
            <!--A container in the middle of the page to hold the map title-->
            <div id="titlebar">
                <h1 class="dynamictitle">State Regulation of Genetics and Insurance</h1>
                <p class="centered-text">
                    The United States Genetic Information Nondiscrimination Act (GINA) prevents health insurers and employers from engaging in genetic discrimination. However, the federal law does not cover life, long-term care, and
                    disability insurers. These insurances are regulated at the state level. There is a range of different types of laws that states have adopted in this area. This map charts the different categories of laws in place across
                    the states.
                </p>
            </div>
            <div id="map"></div>
            <p class="bottom-right"><i>Content current as of May 2025</i></p>
        </div>

        <div class="tooltip" id="tooltip"></div>
        <div class="hovertooltip" id="hovertooltip"></div>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"
            integrity="sha512-vc58qvvBdrDR4etbxMdlTt4GBQk1qjvyORR2nrsPsFPyrs+/u5c3+1Ct6upOgdZoIl7eq6k3a1UPDSNAQi/32A=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.js"></script>

        <script>
            // Adjust the map height on load
            window.onload = function () {
                const titlebarHeight = document.getElementById("titlebar").offsetHeight;
                document.getElementById("map").style.height = `calc(100vh - ${titlebarHeight}px)`;
            };

            // Adjust the map height on window resize
            window.onresize = function () {
                const titlebarHeight = document.getElementById("titlebar").offsetHeight;
                document.getElementById("map").style.height = `calc(100vh - ${titlebarHeight}px)`;
            };

            // Hide the filter-legend by default
            document.getElementById("filter-legend").style.display = "none";

            // Hide all checkbox groups by default
            document.querySelectorAll(".checkbox-group").forEach((group) => {
                group.style.display = "none";
            });

            // Show the corresponding checkbox group when a radio button is clicked
            document.querySelectorAll('input[name="layer"]').forEach((radio) => {
                radio.addEventListener("change", () => {
                    document.querySelectorAll(".checkbox-group").forEach((group) => {
                        group.style.display = "none";
                    });

                    const selectedLayer = radio.value;
                    const checkboxGroup = document.getElementById(selectedLayer + "LayerOptions");
                    if (checkboxGroup) {
                        checkboxGroup.style.display = "block";
                    }
                });
            });

            // Ensure radio buttons are unchecked on page reload
            document.addEventListener("DOMContentLoaded", () => {
                document.getElementById("lifeLayerToggle").checked = false;
                document.getElementById("disabilityLayerToggle").checked = false;
                document.getElementById("ltcLayerToggle").checked = false;
            });

            // Ensure that all checkbox inputs are unchecked on page reload
            document.addEventListener("DOMContentLoaded", () => {
                document.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
                    checkbox.checked = false;
                });
            });

            // Event listener for the "Reset" button
            document.getElementById("resetButton").addEventListener("click", function () {
                // Reload the page
                location.reload();
            });

            // Whenever a radio button is clicked, uncheck all checkboxes
            document.querySelectorAll('input[name="layer"]').forEach((radio) => {
                radio.addEventListener("change", () => {
                    document.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
                        checkbox.checked = false;
                    });
                });
            });

            // Get the height of the titlebar div
            const titlebarHeight = document.getElementById("titlebar").offsetHeight;

            // Define the width and height for the SVG
            const width = window.innerWidth * 0.75;
            const height = window.innerHeight;

            // Create the SVG
            const svg = d3.select("#map").append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${width} ${height}`); // Optional: Use viewBox to control scaling

            // Define the projection
            const projection = d3
                .geoAlbersUsa()
                .translate([width / 2, height / 2])
                .scale(1000);

            // Define the path
            const path = d3.geoPath(projection);

            // Create a tooltip
            const tooltip = d3.select("#tooltip");
            // Create a hovertooltip
            const hovertooltip = d3.select("#hovertooltip");

            // Undefined variable to store the selected filter
            let selectedFilter;
            let selectedRowKey;
            let selectedTitle;

            // Load the data
            Promise.all([d3.csv("data/genetic-privacy.csv"), d3.json("data/states-10m.json")])
                .then(makeMap)
                .catch((error) => console.error("Error loading data:", error));

            // Define an empty object to store the state groups
            let stateGroups = {};

            // Define the function to make the map
            function makeMap([dnaPrivacy, states]) {
                // Store the data in a global variable
                stateGroups = {
                    coverageGroup: svg.append("g").attr("id", "coverageLayer"),
                    filterGroup: svg.append("g").attr("id", "filterLayer"),
                };

                // Define the pattern and add it to the SVG
                svg.append("defs")
                    .append("pattern")
                    .attr("id", "crosshatch-pattern-right")
                    .attr("patternUnits", "userSpaceOnUse")
                    .attr("width", 15)
                    .attr("height", 15)
                    .append("image")
                    .attr("href", "patterns/lines-d-02.png") // Make sure the path is correct
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 15)
                    .attr("height", 15);

                // Define the pattern and add it to the SVG
                svg.append("defs")
                    .append("pattern")
                    .attr("id", "crosshatch-pattern-left")
                    .attr("patternUnits", "userSpaceOnUse")
                    .attr("width", 15)
                    .attr("height", 15)
                    .append("image")
                    .attr("href", "patterns/lines-d-05.png") // Make sure the path is correct
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 15)
                    .attr("height", 15);

                // Define the pattern and add it to the SVG
                svg.append("defs")
                    .append("pattern")
                    .attr("id", "crosshatch-pattern-vertical")
                    .attr("patternUnits", "userSpaceOnUse")
                    .attr("width", 15)
                    .attr("height", 15)
                    .append("image")
                    .attr("href", "patterns/lines-v-02.png") // Make sure the path is correct
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 15)
                    .attr("height", 15);

                // Define the pattern and add it to the SVG
                svg.append("defs")
                    .append("pattern")
                    .attr("id", "crosshatch-pattern-cross")
                    .attr("patternUnits", "userSpaceOnUse")
                    .attr("width", 15)
                    .attr("height", 15)
                    .append("image")
                    .attr("href", "patterns/lines-d-25.png") // Make sure the path is correct
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 15)
                    .attr("height", 15);

                // Define the pattern and add it to the SVG
                svg.append("defs")
                    .append("pattern")
                    .attr("id", "crosshatch-pattern-right-vert")
                    .attr("patternUnits", "userSpaceOnUse")
                    .attr("width", 15)
                    .attr("height", 15)
                    .append("image")
                    .attr("href", "patterns/lines-dv-22.png") // Make sure the path is correct
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 15)
                    .attr("height", 15);

                // Define the pattern and add it to the SVG
                svg.append("defs")
                    .append("pattern")
                    .attr("id", "crosshatch-pattern-left-vert")
                    .attr("patternUnits", "userSpaceOnUse")
                    .attr("width", 15)
                    .attr("height", 15)
                    .append("image")
                    .attr("href", "patterns/lines-dv-25.png") // Make sure the path is correct
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 15)
                    .attr("height", 15);

                // Define the pattern and add it to the SVG
                svg.append("defs")
                    .append("pattern")
                    .attr("id", "crosshatch-pattern-all")
                    .attr("patternUnits", "userSpaceOnUse")
                    .attr("width", 15)
                    .attr("height", 15)
                    .append("image")
                    .attr("href", "patterns/lines-dv-all.png") // Make sure the path is correct
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 15)
                    .attr("height", 15);

                // Define the zoom behavior
                const zoom = d3.zoom().scaleExtent([0, 8]).on("zoom", zoomed);
                // Call the zoom behavior on the SVG
                svg.call(zoom);

                // Define the zoomed function
                function zoomed(event) {
                    svg.selectAll("g").attr("transform", event.transform);
                }

                // Get the bounds of the map
                const bounds = path.bounds(topojson.feature(states, states.objects.states));

                // Calculate the initial scale
                const initialScale = Math.min(width / (bounds[1][0] - bounds[0][0]), height / (bounds[1][1] - bounds[0][1])) * 0.9;
                // Call the zoom behavior on the SVG
                svg.call(
                    zoom.transform,
                    d3.zoomIdentity
                        .translate(width / 2, height / 2)
                        .scale(initialScale)
                        .translate(-width / 2, -height / 2)
                );

                // Listen for a click on a radio button
                document.querySelectorAll('input[name="layer"]').forEach((radio) => {
                    radio.addEventListener("click", function () {
                        // Hide the legend
                        document.getElementById("legend").style.display = "none";
                        // Show the filter-legend
                        document.getElementById("filter-legend").style.display = "block";

                        // Get the current filters
                        const filters = {
                            life: document.getElementById("lifeLayerToggle").checked,
                            disability: document.getElementById("disabilityLayerToggle").checked,
                            ltc: document.getElementById("ltcLayerToggle").checked,
                        };

                        // Determine which filter is checked
                        selectedFilter = Object.keys(filters).find((key) => filters[key]);

                        // If selectedFilter is 'ltc', change selectedRowKey to 'LTC'
                        if (selectedFilter === "ltc") {
                            selectedRowKey = "LTC";
                        } else {
                            // Create a capitalized version of the selected filter
                            selectedRowKey = selectedFilter.charAt(0).toUpperCase() + selectedFilter.slice(1);
                        }

                        // If selectedRowKey is 'LTC', change selectedTitle to 'Long-Term Care'
                        if (selectedRowKey === "LTC") {
                            selectedTitle = "Long-Term Care";
                        } else {
                            // Create a capitalized version of the selected filter
                            selectedTitle = selectedRowKey;
                        }

                        // Feed the selectedTitle to the title bar at the top of the page
                        document.querySelector(".dynamictitle").textContent = `${selectedTitle} Insurance-Related Laws`;

                        // Clear previous filters for checkboxes
                        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach((checkbox) => {
                            checkbox.checked = false; // Reset all checkboxes
                        });

                        // Clear previous shading before applying new shading
                        stateGroups.coverageGroup.selectAll("path").style("fill", "rgb(251,247,245)");

                        // Iterate through every path (state) and apply a color based on the selectedRowKey value
                        stateGroups.coverageGroup.selectAll("path").style("fill", (d) => {
                            // Check if any row in dnaPrivacy matches the state's name and has a truthy selectedRowKey value
                            const stateName = d.properties.name;
                            const isStateShadedBlue = dnaPrivacy.some((row) => row.State === stateName && row[selectedRowKey]);

                            // Return the color based on whether any row meets the criteria
                            return isStateShadedBlue ? "rgb(232,176,172)" : "rgb(251,247,245)";
                        });

                        // Add click event listeners to checkboxes again, if they were reset
                        checkboxes.forEach((checkbox) => {
                            checkbox.addEventListener("click", function () {
                                // Get the layer options filters using selectedFilter
                                const subfilters = Object.fromEntries(Array.from(document.querySelectorAll('input[name="' + selectedFilter + 'Options"]')).map((option) => [option.value, option.checked]));

                                // Apply the filters
                                applyFilters(states, dnaPrivacy, filters, subfilters);
                            });
                        });

                        // Apply initial filters when a radio button is clicked (after checkbox resets)
                        applyFilters(states, dnaPrivacy, filters, {});
                    });
                });

                stateGroups.coverageGroup.style("visibility", "visible");
                stateGroups.filterGroup.style("visibility", "hidden");

                const groupedData = groupAndCountEntriesForStates(dnaPrivacy);

                // Draw initial map
                drawCoverageLayer(stateGroups.coverageGroup, states, groupedData);

                // Populate the sidebar with all state details
                populateStateDetails(groupedData);

                // STATE LAW COMPARISON START
                // List of US states
                const compStates = [
                    "None selected",
                    "Alabama",
                    "Alaska",
                    "Arizona",
                    "Arkansas",
                    "California",
                    "Colorado",
                    "Connecticut",
                    "Delaware",
                    "Florida",
                    "Georgia",
                    "Hawaii",
                    "Idaho",
                    "Illinois",
                    "Indiana",
                    "Iowa",
                    "Kansas",
                    "Kentucky",
                    "Louisiana",
                    "Maine",
                    "Maryland",
                    "Massachusetts",
                    "Michigan",
                    "Minnesota",
                    "Mississippi",
                    "Missouri",
                    "Montana",
                    "Nebraska",
                    "Nevada",
                    "New Hampshire",
                    "New Jersey",
                    "New Mexico",
                    "New York",
                    "North Carolina",
                    "North Dakota",
                    "Ohio",
                    "Oklahoma",
                    "Oregon",
                    "Pennsylvania",
                    "Rhode Island",
                    "South Carolina",
                    "South Dakota",
                    "Tennessee",
                    "Texas",
                    "Utah",
                    "Vermont",
                    "Virginia",
                    "Washington",
                    "West Virginia",
                    "Wisconsin",
                    "Wyoming",
                ];

                // Populate the dropdown menus
                const firstStateDropdown = document.getElementById("firstStateDropdown");
                const secondStateDropdown = document.getElementById("secondStateDropdown");

                compStates.forEach((state) => {
                    const option1 = document.createElement("option");
                    option1.value = state;
                    option1.textContent = state;
                    firstStateDropdown.appendChild(option1);

                    const option2 = document.createElement("option");
                    option2.value = state;
                    option2.textContent = state;
                    secondStateDropdown.appendChild(option2);
                });

                // Get the modal
                const modal = document.getElementById("myModal");

                // Get the button that opens the modal
                const btn = document.getElementById("compareButton");

                // Get the <span> element that closes the modal
                const span = document.getElementsByClassName("close")[0];

                // When the user clicks on <span> (x), close the modal
                span.onclick = function () {
                    modal.style.display = "none";
                };

                // When the user clicks anywhere outside of the modal, close it
                window.onclick = function (event) {
                    if (event.target == modal) {
                        modal.style.display = "none";
                    }
                };

                // Update the table headers when a state is selected
                firstStateDropdown.onchange = function () {
                    document.getElementById("firstStateHead").textContent = firstStateDropdown.value;
                };

                secondStateDropdown.onchange = function () {
                    // Prevent the user from selecting the same state in both dropdowns
                    if (firstStateDropdown.value === secondStateDropdown.value) {
                        alert("Please select two different states to compare.");
                        secondStateDropdown.value = "None selected";
                    }
                    document.getElementById("secondStateHead").textContent = secondStateDropdown.value;
                };

                // create an empty array to store the firstStateLife values
                const firstStateLife = [];
                // create an empty array to store the secondStateLife values
                const secondStateLife = [];
                // create an empty array to store the firstStateDisability values
                const firstStateDisability = [];
                // create an empty array to store the secondStateDisability values
                const secondStateDisability = [];
                // create an empty array to store the firstStateLTC values
                const firstStateLTC = [];
                // create an empty array to store the secondStateLTC values
                const secondStateLTC = [];

                // When the user clicks the button, open the modal
                btn.onclick = function () {
                    modal.style.display = "block";

                    // clear the arrays
                    firstStateLife.length = 0;
                    secondStateLife.length = 0;
                    firstStateDisability.length = 0;
                    secondStateDisability.length = 0;
                    firstStateLTC.length = 0;
                    secondStateLTC.length = 0;

                    // run needed functions here

                    // Iterate through each key in the first object of groupAndCountEntriesForComparison(dnaPrivacy, firstStateDropdown.value, secondStateDropdown.value)
                    const firstState = groupAndCountEntriesForComparison(dnaPrivacy, firstStateDropdown.value, secondStateDropdown.value)[0][firstStateDropdown.value];
                    const secondState = groupAndCountEntriesForComparison(dnaPrivacy, firstStateDropdown.value, secondStateDropdown.value)[1][secondStateDropdown.value];

                    if (firstState.life1) {
                        firstStateLife.push("Requires informed consent");
                    }
                    if (firstState.life2) {
                        firstStateLife.push("Prohibits use of genetic info");
                    }
                    if (firstState.life3) {
                        firstStateLife.push("Allowed if actuarially justified");
                    }
                    if (firstState.life4) {
                        firstStateLife.push("Bars use of a specific trait");
                    }
                    if (firstState.life5) {
                        firstStateLife.push("Other");
                    }
                    // if none of the above conditions are met, push 'N/A' to the firstStateLife array
                    if (!firstState.life1 && !firstState.life2 && !firstState.life3 && !firstState.life4 && !firstState.life5) {
                        firstStateLife.push("N/A");
                    }

                    if (secondState.life1) {
                        secondStateLife.push("Requires informed consent");
                    }
                    if (secondState.life2) {
                        secondStateLife.push("Prohibits use of genetic info");
                    }
                    if (secondState.life3) {
                        secondStateLife.push("Allowed if actuarially justified");
                    }
                    if (secondState.life4) {
                        secondStateLife.push("Bars use of a specific trait");
                    }
                    if (secondState.life5) {
                        secondStateLife.push("Other");
                    }
                    // if none of the above conditions are met, push 'N/A' to the secondStateLife array
                    if (!secondState.life1 && !secondState.life2 && !secondState.life3 && !secondState.life4 && !secondState.life5) {
                        secondStateLife.push("N/A");
                    }

                    if (firstState.disability1) {
                        firstStateDisability.push("Requires informed consent");
                    }
                    if (firstState.disability2) {
                        firstStateDisability.push("Prohibits use of genetic info");
                    }
                    if (firstState.disability3) {
                        firstStateDisability.push("Allowed if actuarially justified");
                    }
                    if (firstState.disability4) {
                        firstStateDisability.push("Bars use of a specific trait");
                    }
                    if (firstState.disability5) {
                        firstStateDisability.push("Other");
                    }
                    // if none of the above conditions are met, push 'N/A' to the firstStateDisability array
                    if (!firstState.disability1 && !firstState.disability2 && !firstState.disability3 && !firstState.disability4 && !firstState.disability5) {
                        firstStateDisability.push("N/A");
                    }

                    if (secondState.disability1) {
                        secondStateDisability.push("Requires informed consent");
                    }
                    if (secondState.disability2) {
                        secondStateDisability.push("Prohibits use of genetic info");
                    }
                    if (secondState.disability3) {
                        secondStateDisability.push("Allowed if actuarially justified");
                    }
                    if (secondState.disability4) {
                        secondStateDisability.push("Bars use of a specific trait");
                    }
                    if (secondState.disability5) {
                        secondStateDisability.push("Other");
                    }
                    // if none of the above conditions are met, push 'N/A' to the secondStateDisability array
                    if (!secondState.disability1 && !secondState.disability2 && !secondState.disability3 && !secondState.disability4 && !secondState.disability5) {
                        secondStateDisability.push("N/A");
                    }

                    if (firstState.ltc1) {
                        firstStateLTC.push("Requires informed consent");
                    }
                    if (firstState.ltc2) {
                        firstStateLTC.push("Prohibits use of genetic info");
                    }
                    if (firstState.ltc3) {
                        firstStateLTC.push("Allowed if actuarially justified");
                    }
                    if (firstState.ltc4) {
                        firstStateLTC.push("Bars use of a specific trait");
                    }
                    if (firstState.ltc5) {
                        firstStateLTC.push("Other");
                    }
                    // if none of the above conditions are met, push 'N/A' to the firstStateLTC array
                    if (!firstState.ltc1 && !firstState.ltc2 && !firstState.ltc3 && !firstState.ltc4 && !firstState.ltc5) {
                        firstStateLTC.push("N/A");
                    }

                    if (secondState.ltc1) {
                        secondStateLTC.push("Requires informed consent");
                    }
                    if (secondState.ltc2) {
                        secondStateLTC.push("Prohibits use of genetic info");
                    }
                    if (secondState.ltc3) {
                        secondStateLTC.push("Allowed if actuarially justified");
                    }
                    if (secondState.ltc4) {
                        secondStateLTC.push("Bars use of a specific trait");
                    }
                    if (secondState.ltc5) {
                        secondStateLTC.push("Other");
                    }
                    // if none of the above conditions are met, push 'N/A' to the secondStateLTC array
                    if (!secondState.ltc1 && !secondState.ltc2 && !secondState.ltc3 && !secondState.ltc4 && !secondState.ltc5) {
                        secondStateLTC.push("N/A");
                    }

                    // Update the table with the values
                    document.getElementById("firstStateLife").innerHTML = firstStateLife.join("<br>");
                    document.getElementById("secondStateLife").innerHTML = secondStateLife.join("<br>");
                    document.getElementById("firstStateDisability").innerHTML = firstStateDisability.join("<br>");
                    document.getElementById("secondStateDisability").innerHTML = secondStateDisability.join("<br>");
                    document.getElementById("firstStateLTC").innerHTML = firstStateLTC.join("<br>");
                    document.getElementById("secondStateLTC").innerHTML = secondStateLTC.join("<br>");
                };
                // STATE LAW COMPARISON END
            }

            function drawCoverageLayer(layerGroup, states, data) {
                // Define the color scale
                const colorScale = d3.scaleLinear().domain([0, 1, 2, 3]).range(["rgb(251,247,245)", "lightblue", "blue", "darkblue"]);

                // Draw the background paths based on the state shapes
                layerGroup
                    .selectAll("path.background")
                    .data(topojson.feature(states, states.objects.states).features)
                    .join("path")
                    .attr("class", "background")
                    .attr("d", path) // Use the path generator directly for the background
                    .attr("fill", "rgb(232,176,172)") // Background color
                    .attr("opacity", 1); // Optional: make it semi-transparent

                // Now, draw the state paths on top of the background
                layerGroup
                    .selectAll("path.state")
                    .data(topojson.feature(states, states.objects.states).features)
                    .join("path")
                    .attr("class", "state")
                    .attr("d", path) // Use the same path generator
                    .attr("fill", (d) => {
                        const stateData = data.find((state) => state.name === d.properties.name);
                        if (stateData) {
                            // If all three properties are set to true, overlay the crosshatch pattern
                            if (stateData.life && stateData.disability && stateData.ltc) {
                                // Fill state with the crosshatch pattern
                                return "url(#crosshatch-pattern-all)";
                            }
                            // If both the "life" and "disability" properties are set to true, overlay both crosshatch patterns
                            if (stateData.life && stateData.disability) {
                                // Fill state with the crosshatch pattern
                                return "url(#crosshatch-pattern-cross)";
                            }
                            // If both the "life" and "ltc" properties are set to true, overlay both crosshatch patterns
                            if (stateData.life && stateData.ltc) {
                                // Fill state with the crosshatch pattern
                                return "url(#crosshatch-pattern-right-vert)";
                            }
                            // If both the "disability" and "ltc" properties are set to true, overlay both crosshatch patterns
                            if (stateData.disability && stateData.ltc) {
                                // Fill state with the crosshatch pattern
                                return "url(#crosshatch-pattern-left-vert)";
                            }
                            // If the state has a "life" property set to true, fill it with a crosshatch pattern
                            if (stateData.life) {
                                // Fill state with the crosshatch pattern
                                return "url(#crosshatch-pattern-right)";
                            }
                            // If the state has a "disability" property set to true, fill it with a crosshatch pattern
                            if (stateData.disability) {
                                // Fill state with the crosshatch pattern
                                return "url(#crosshatch-pattern-left)";
                            }
                            // If the state has ONLY the "ltc" property set to true, fill it with a crosshatch pattern
                            if (stateData.ltc) {
                                // Fill state with the crosshatch pattern
                                return "url(#crosshatch-pattern-vertical)";
                            } else {
                                // Default fill color if stateData is not found
                                return "rgb(251,247,245)";
                            }
                        }
                    })
                    .attr("stroke", "gray")
                    .attr("stroke-width", 0.5)
                    .on("mouseover", function (event, d) {
                        d3.select(this).classed("highlighted", true).raise();
                        // Show a tooltip with the state name and "click for more info" underneath the state name
                        const x = event.pageX;
                        const y = event.pageY;
                        showHoverTooltip(`<div style="font-size: 14px; font-weight: bold;">${d.properties.name}</div><div style="font-size: 12px;">Click for more info</div>`, x, y);
                        // Move the hovertooltip as the mouse moves
                        d3.select(this).on("mousemove", function (event) {
                            const x = event.pageX;
                            const y = event.pageY;
                            d3.select("#hovertooltip")
                                .style("left", `${x + 10}px`)
                                .style("top", `${y + 10}px`);
                        });
                    })
                    .on("click", function (event, d) {
                        const stateName = d.properties.name;
                        const stateData = data.find((state) => state.name === stateName);

                        // Create the code list with hyperlinks
                        const codeList = stateData
                            ? stateData.codes
                                  .map((code) => {
                                      let entries = [];
                                      if (code.disability) entries.push("Disability");
                                      if (code.life) entries.push("Life");
                                      if (code.ltc) entries.push("LTC");
                                      let entriesText = entries.length > 1 ? entries.join(", ") : entries[0] || "N/A";

                                      // Conditionally create the row with or without the hyperlink
                                      const codeContent = code.link && code.link !== "" ? `<a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code || "N/A"}</a>` : code.code || "N/A";

                                      return `<tr><td>${codeContent}</td><td title="${entries.length ? entriesText : "N/A"}">${entriesText}</td></tr>`;
                                  })
                                  .join("")
                            : '<tr><td title="N/A">N/A</td><td title="N/A">N/A</td></tr>';

                        // Add the table headers
                        const tableHeaders = `<thead><tr><th>Laws</th><th>Type</th></tr></thead>`;

                        // Create tooltip content with close button
                        const tooltipContent = `<div style="font-size: 14px; font-weight: bold;">${stateName}</div><table>${tableHeaders}<tbody>${codeList}</tbody></table><button class="close" id="tooltip-close">&times;</button>`;

                        const x = event.pageX;
                        const y = event.pageY;

                        // Show the tooltip with content
                        showTooltip(tooltipContent, x, y);

                        // Hide the hovertooltip
                        hideHoverTooltip();

                        // Prevent click event from bubbling up to the body
                        event.stopPropagation();
                    })
                    .on("mouseout", function () {
                        hideHoverTooltip();
                        d3.select(this).classed("highlighted", false);
                    });

                // Hide tooltip when clicking outside
                d3.select("body").on("click", function () {
                    hideTooltip();
                });
            }

            let subcons = [];

            function drawCoverageLayerFiltered(layerGroup, states, filtered, all, subfilters) {
                // Define a coverage strength color scale
                const coverageColorScale = d3.scaleOrdinal().domain(["2", "4", "3", "1", "5"]).range(["#4A0403", "#8B1A17", "#C23B37", "#E8B0AC", "#F4D5D3"]);

                const newFilters = {
                    life: document.getElementById("lifeLayerToggle").checked,
                    disability: document.getElementById("disabilityLayerToggle").checked,
                    ltc: document.getElementById("ltcLayerToggle").checked,
                };

                layerGroup
                    .selectAll("path")
                    .data(topojson.feature(states, states.objects.states).features)
                    .join("path")
                    .attr("d", path)
                    .attr("fill", (d) => {
                        const stateData = filtered.find((state) => state.name === d.properties.name);
                        // Skip 'undefined' values
                        if (stateData) {
                            // Check for stateData['2'] first
                            if (stateData["2"]) {
                                const color = coverageColorScale("2");
                                delete stateData["2"]; // Remove it from consideration
                                return color;
                            }

                            // Check for stateData['4']
                            if (stateData["4"]) {
                                const color = coverageColorScale("4");
                                delete stateData["4"];
                                return color;
                            }

                            // Check for stateData['3']
                            if (stateData["3"]) {
                                const color = coverageColorScale("3");
                                delete stateData["3"];
                                return color;
                            }

                            // Check for stateData['1']
                            if (stateData["1"]) {
                                const color = coverageColorScale("1");
                                delete stateData["1"];
                                return color;
                            }

                            // Check for stateData['5']
                            if (stateData["5"]) {
                                const color = coverageColorScale("5");
                                delete stateData["5"];
                                return color;
                            }
                        } else {
                            return "rgb(251,247,245)";
                        }
                    })
                    .attr("stroke", "gray")
                    .attr("stroke-width", 0.5)
                    .on("mouseover", function (event, d) {
                        d3.select(this).classed("highlighted", true).raise();
                        // Show a tooltip with the state name and "click for more info" underneath the state name
                        const x = event.pageX;
                        const y = event.pageY;
                        showHoverTooltip(`<div style="font-size: 14px; font-weight: bold;">${d.properties.name}</div><div style="font-size: 12px;">Click for more info</div>`, x, y);
                        // Move the hovertooltip as the mouse moves
                        d3.select(this).on("mousemove", function (event) {
                            const x = event.pageX;
                            const y = event.pageY;
                            d3.select("#hovertooltip")
                                .style("left", `${x + 10}px`)
                                .style("top", `${y + 10}px`);
                        });
                    })
                    .on("click", function (event, d) {
                        const stateName = d.properties.name;
                        const stateData = all.find((state) => state.name === stateName);

                        // Apply filters based on newFilters
                        if (newFilters.life) {
                            stateData.codes = stateData.codes.filter((code) => code.life);
                        } else if (newFilters.disability) {
                            stateData.codes = stateData.codes.filter((code) => code.disability);
                        } else if (newFilters.ltc) {
                            stateData.codes = stateData.codes.filter((code) => code.ltc);
                        }

                        // Check if any checkboxes are checked
                        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                        const anyChecked = Array.from(checkboxes).some((checkbox) => checkbox.checked);

                        // If no checkboxes are checked, show all codes
                        if (!anyChecked) {
                            stateData.codes = stateData.codes; // No need to filter
                        } else {
                            const selectedBox = Object.keys(subfilters).filter((key) => subfilters[key]);
                            stateData.codes = stateData.codes.filter((code) => {
                                return selectedBox.some((value) => code[selectedFilter].includes(value));
                            });
                        }

                        // Create the code list with descriptions
                        const codeList = stateData.codes
                            .map((code) => {
                                let entries = [];
                                if (code[selectedFilter].includes("1")) entries.push("<div>• Requires informed consent</div>");
                                if (code[selectedFilter].includes("2")) entries.push("<div>• Prohibits use of genetic info</div>");
                                if (code[selectedFilter].includes("3")) entries.push("<div>• Allowed if actuarially justified</div>");
                                if (code[selectedFilter].includes("4")) entries.push("<div>• Bars use of a specific trait</div>");
                                if (code[selectedFilter].includes("5")) entries.push("<div>• Other</div>");

                                let entriesText = entries.length > 0 ? entries.join("") : "N/A";
                                return `<tr><td><a style="color:#004b9b;" href="${code.link || "#"}" target="_blank">${code.code || "N/A"}</a></td><td>${entriesText}</td></tr>`;
                            })
                            .join("");

                        const newCodeList = codeList || "<tr><td>N/A</td><td>N/A</td></tr>";

                        // Create tooltip content with close button
                        const tooltipContent = `
        <div style="font-size: 14px; font-weight: bold;">${stateName}</div>
        <table>
            <thead>
                <tr><th>Laws</th><th>Coverage</th></tr>
            </thead>
            <tbody>${newCodeList}</tbody>
        </table>
        <button class="close" id="tooltip-close">&times;</button>
    `;

                        const x = event.pageX;
                        const y = event.pageY;

                        // Show the tooltip with content
                        showTooltip(tooltipContent, x, y);

                        // Hide the hovertooltip
                        hideHoverTooltip();

                        // Prevent click event from bubbling up to the body
                        event.stopPropagation();
                    })
                    /*        
                .on("mousemove", function(event) {
                  const x = event.pageX;
                  const y = event.pageY;

                  const tooltip = document.querySelector('.tooltip');

                  // Set initial position
                  tooltip.style.left = `${x + 5}px`;
                  tooltip.style.top = `${y - 28}px`;
                })
        */
                    .on("mouseout", function () {
                        d3.select(this).classed("highlighted", false);
                        hideHoverTooltip();
                    });
            }

            function applyFilters(states, dnaPrivacy, filters, subfilters) {
                const filteredData = dnaPrivacy.filter((row) => {
                    return !filters.life || row["Life"] || !filters.disability || row["Disability"] || !filters.ltc || row["LTC"];
                });

                const groupedData = groupAndCountEntriesForStates(filteredData);

                const filteredStateData = groupedData.filter((d) => {
                    const mainFiltersMatch = (filters.life ? d.life : true) && (filters.disability ? d.disability : true) && (filters.ltc ? d.ltc : true);

                    // Check if all true values in subfilters are also true in filteredStateData
                    const subfiltersMatch = Object.entries(subfilters).every(([key, value]) => {
                        return value ? d[key] : true;
                    });

                    return mainFiltersMatch && subfiltersMatch;
                });

                console.log(filteredStateData);

                stateGroups.coverageGroup.style("visibility", "hidden");
                stateGroups.filterGroup.style("visibility", "visible");

                drawCoverageLayerFiltered(stateGroups.filterGroup, states, filteredStateData, groupedData, subfilters);

                // Populate state details in the sidebar
                populateStateDetails(filteredStateData, filters, subfilters);
            }

            function populateStateDetails(stateData, filters, subfilters) {
                const stateDetailsContainer = document.getElementById("stateDetails");
                stateDetailsContainer.innerHTML = "";

                stateData.forEach((state) => {
                    const stateElement = document.createElement("div");
                    stateElement.style.marginBottom = "10px";

                    let filteredCodes = state.codes;

                    // Apply filters if they are defined
                    if (filters) {
                        if (filters.life) {
                            filteredCodes = filteredCodes.filter((code) => code.life);
                        } else if (filters.disability) {
                            filteredCodes = filteredCodes.filter((code) => code.disability);
                        } else if (filters.ltc) {
                            filteredCodes = filteredCodes.filter((code) => code.ltc);
                        }
                    }

                    // Check if any checkboxes are checked
                    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                    const anyChecked = Array.from(checkboxes).some((checkbox) => checkbox.checked);

                    // if 'input[type="checkbox"]' is not checked, then show all codes
                    if (!anyChecked) {
                        filteredCodes = filteredCodes;
                    } else {
                        // Check subfilters and return the keys that are true
                        const selectedBox = Object.keys(subfilters).filter((key) => subfilters[key]);
                        // Filter the codes based on the selectedBox values
                        filteredCodes = filteredCodes.filter((code) => {
                            // Return the codes where code[selectedFilter] includes one of the values in selectedBox
                            return selectedBox.some((value) => code[selectedFilter].includes(value));
                        });
                    }

                    // define empty variables
                    let stateName;
                    let codeList;
                    let codeTable;

                    if (state.count != 0) {
                        stateName = document.createElement("div");
                        stateName.innerHTML = `<strong style="font-size: 14px;">${state.name}</strong>`;
                        stateElement.appendChild(stateName);
                        // If a radio button is selected
                        if (filters) {
                            codeList = filteredCodes
                                .map((code) => {
                                    let entries = [];
                                    if (code[selectedFilter].includes("1")) entries.push("<li>Requires informed consent</li>");
                                    if (code[selectedFilter].includes("2")) entries.push("<li>Prohibits use of genetic info</li>");
                                    if (code[selectedFilter].includes("3")) entries.push("<li>Allowed if actuarially justified</li>");
                                    if (code[selectedFilter].includes("4")) entries.push("<li>Bars use of a specific trait</li>");
                                    if (code[selectedFilter].includes("5")) entries.push("<li>Other</li>");
                                    // Combine entries into a single string
                                    let entriesText = entries.length > 0 ? entries.join("<br>") : "<li>N/A</li>";
                                    return `<tr><td><a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a></td><td title="${entries.length ? entriesText : "N/A"}"><ul>${entriesText}</ul></td></tr>`;
                                })
                                .join("");
                        } else {
                            codeList = filteredCodes
                                .map((code) => {
                                    let entries = [];
                                    if (code.life) entries.push("Life");
                                    if (code.disability) entries.push("Disability");
                                    if (code.ltc) entries.push("LTC");
                                    let entriesText = entries.length > 1 ? entries.join(", ") : entries[0] || "N/A";
                                    return `<tr><td><a style="color:#004b9b;" href="${code.link}" target="_blank">${code.code}</a></td><td title="${entries.length ? entriesText : "N/A"}">${entriesText}</td></tr>`;
                                })
                                .join("");
                        }
                        codeTable = document.createElement("table");
                        codeTable.innerHTML = codeList;
                        stateElement.appendChild(codeTable);
                        stateDetailsContainer.appendChild(stateElement);
                    } else {
                        stateName = "";
                        codeList = "";
                        codeTable = "";
                    }
                });
            }

            function groupAndCountEntriesForComparison(data, selection1, selection2) {
                const selection1DataMap = {};
                const selection2DataMap = {};

                data.forEach((row) => {
                    const state = row.State;
                    if (state === selection1) {
                        if (!selection1DataMap[state]) {
                            selection1DataMap[state] = {
                                name: state,
                                life: false,
                                life1: false,
                                life2: false,
                                life3: false,
                                life4: false,
                                life5: false,
                                disability: false,
                                disability1: false,
                                disability2: false,
                                disability3: false,
                                disability4: false,
                                disability5: false,
                                ltc: false,
                                ltc1: false,
                                ltc2: false,
                                ltc3: false,
                                ltc4: false,
                                ltc5: false,
                                codes: [],
                            };
                        }
                        if (row.Life) selection1DataMap[state].life = true;
                        if (row.Disability) selection1DataMap[state].disability = true;
                        if (row.LTC) selection1DataMap[state].ltc = true;

                        // Process subfilter selections
                        // Check if row.Life exists and process subfilter selections
                        if (row.Life) {
                            // Split the string into an array of values
                            const lifeSubValues = row["Life"].split(",");
                            // Iterate over each value and...
                            lifeSubValues.forEach((value) => {
                                // ...update corresponding object keys
                                selection1DataMap[state]["life" + value] = true;
                            });
                        }
                        // Check if row.Disability exists and process subfilter selections
                        if (row.Disability) {
                            // Split the string into an array of values
                            const disabilitySubValues = row["Disability"].split(",");
                            // Iterate over each value and...
                            disabilitySubValues.forEach((value) => {
                                // ...update corresponding object keys
                                selection1DataMap[state]["disability" + value] = true;
                            });
                        }
                        // Check if row.LTC exists and process subfilter selections
                        if (row.LTC) {
                            // Split the string into an array of values
                            const ltcSubValues = row["LTC"].split(",");
                            // Iterate over each value and...
                            ltcSubValues.forEach((value) => {
                                // ...update corresponding object keys
                                selection1DataMap[state]["ltc" + value] = true;
                            });
                        }
                        // Push the code object to the codes array
                        selection1DataMap[state].codes.push({
                            code: row.Code,
                            link: row.Link,
                            life: row.Life,
                            disability: row.Disability,
                            ltc: row.LTC,
                        });
                    } else if (state === selection2) {
                        if (!selection2DataMap[state]) {
                            selection2DataMap[state] = {
                                name: state,
                                life: false,
                                life1: false,
                                life2: false,
                                life3: false,
                                life4: false,
                                life5: false,
                                disability: false,
                                disability1: false,
                                disability2: false,
                                disability3: false,
                                disability4: false,
                                disability5: false,
                                ltc: false,
                                ltc1: false,
                                ltc2: false,
                                ltc3: false,
                                ltc4: false,
                                ltc5: false,
                                codes: [],
                            };
                        }
                        if (row.Life) selection2DataMap[state].life = true;
                        if (row.Disability) selection2DataMap[state].disability = true;
                        if (row.LTC) selection2DataMap[state].ltc = true;

                        // Process subfilter selections
                        // Check if row.Life exists and process subfilter selections
                        if (row.Life) {
                            // Split the string into an array of values
                            const lifeSubValues = row["Life"].split(",");
                            // Iterate over each value and...
                            lifeSubValues.forEach((value) => {
                                // ...update corresponding object keys
                                selection2DataMap[state]["life" + value] = true;
                            });
                        }
                        // Check if row.Disability exists and process subfilter selections
                        if (row.Disability) {
                            // Split the string into an array of values
                            const disabilitySubValues = row["Disability"].split(",");
                            // Iterate over each value and...
                            disabilitySubValues.forEach((value) => {
                                // ...update corresponding object keys
                                selection2DataMap[state]["disability" + value] = true;
                            });
                        }
                        // Check if row.LTC exists and process subfilter selections
                        if (row.LTC) {
                            // Split the string into an array of values
                            const ltcSubValues = row["LTC"].split(",");
                            // Iterate over each value and...
                            ltcSubValues.forEach((value) => {
                                // ...update corresponding object keys
                                selection2DataMap[state]["ltc" + value] = true;
                            });
                        }

                        selection2DataMap[state].codes.push({
                            code: row.Code,
                            link: row.Link,
                            life: row.Life,
                            disability: row.Disability,
                            ltc: row.LTC,
                        });
                    }
                });

                // return selection1DataMap and selection2DataMap
                return [selection1DataMap, selection2DataMap];
            }

            function groupAndCountEntriesForStates(data) {
                const stateDataMap = {};

                data.forEach((row) => {
                    const state = row.State;
                    if (!stateDataMap[state]) {
                        stateDataMap[state] = {
                            name: state,
                            life: false,
                            disability: false,
                            ltc: false,
                            1: false,
                            2: false,
                            3: false,
                            4: false,
                            5: false,
                            codes: [],
                        };
                    }
                    if (row.Life) stateDataMap[state].life = true;
                    if (row.Disability) stateDataMap[state].disability = true;
                    if (row.LTC) stateDataMap[state].ltc = true;

                    // Check if row[selectedRowKey] exists and process subfilter selections
                    if (row[selectedRowKey]) {
                        // Split the selectedRowKey string into an array of values
                        const selectedValues = row[selectedRowKey].split(",");

                        // Iterate over each value and update corresponding object keys
                        selectedValues.forEach((value) => {
                            stateDataMap[state][value] = true;
                        });
                    }

                    stateDataMap[state].codes.push({
                        code: row.Code,
                        link: row.Link,
                        life: row.Life,
                        disability: row.Disability,
                        ltc: row.LTC,
                    });
                });

                const result = Object.values(stateDataMap).map((state) => ({
                    name: state.name,
                    life: state.life,
                    disability: state.disability,
                    ltc: state.ltc,
                    1: state[1],
                    2: state[2],
                    3: state[3],
                    4: state[4],
                    5: state[5],
                    count: [state.life, state.disability, state.ltc].filter(Boolean).length,
                    codes: state.codes,
                }));

                return result;
            }

            // Function to uncheck all checkboxes
            function uncheckAllCheckboxes() {
                // radio buttons
                document.getElementById("lifeLayerToggle").checked = false;
                document.getElementById("disabilityLayerToggle").checked = false;
                document.getElementById("ltcLayerToggle").checked = false;
                // subcategory check boxes
                document.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
                    checkbox.checked = false;
                });
                // hide all checkbox groups
                document.querySelectorAll(".checkbox-group").forEach((group) => {
                    group.style.display = "none";
                });
            }
            /*
        // Functions to handle tooltip positioning
        function showTooltip(htmlContent, x, y) {
          const tooltip = document.querySelector('.tooltip');
          tooltip.innerHTML = htmlContent;

          // Set initial position
          tooltip.style.left = `${x}px`;
          tooltip.style.top = `${y}px`;

          // Get the tooltip and map dimensions
          const tooltipRect = tooltip.getBoundingClientRect();
          const mapRect = document.querySelector('#map').getBoundingClientRect();

          // Adjust the position if the tooltip is too close to the right edge
          if (tooltipRect.right > mapRect.right) {
            tooltip.style.left = `${mapRect.right - tooltipRect.width}px`;
          }

          // Adjust the position if the tooltip is too close to the left edge
          if (tooltipRect.left < mapRect.left) {
            tooltip.style.left = `${mapRect.left}px`;
          }

          // Adjust the position if the tooltip is too close to the bottom edge
          if (tooltipRect.bottom > mapRect.bottom) {
            tooltip.style.top = `${mapRect.bottom - tooltipRect.height}px`;
          }

          // Adjust the position if the tooltip is too close to the top edge
          if (tooltipRect.top < mapRect.top) {
            tooltip.style.top = `${mapRect.top}px`;
          }

          // Show the tooltip
          tooltip.classList.add('visible');
        }

        function hideTooltip() {
          const tooltip = document.querySelector('.tooltip');
          tooltip.classList.remove('visible');
        }
    */
            // Collapsible content instructions
            // Get the collapsible section, header, and button
            const collapsibleSectionOverview = document.querySelector(".collapsible-overview");
            const collapsibleSectionProvisions = document.querySelector(".collapsible-provisions");
            const collapsibleSectionComparison = document.querySelector(".collapsible-comparison");
            const collapsibleSectionRegulation = document.querySelector(".collapsible-regulation");
            const collapsibleSectionLaws = document.querySelector(".collapsible-laws");
            const collapsibleHeaderOverview = document.querySelector(".collapsible-header-overview");
            const collapsibleHeaderProvisions = document.querySelector(".collapsible-header-provisions");
            const collapsibleHeaderComparison = document.querySelector(".collapsible-header-comparison");
            const collapsibleHeaderRegulation = document.querySelector(".collapsible-header-regulation");
            const collapsibleHeaderLaws = document.querySelector(".collapsible-header-laws");
            const compareButton = document.getElementById("compareButton");

            // Toggle the visibility of the collapsible content when the header is clicked
            collapsibleHeaderOverview.addEventListener("click", function () {
                const content = collapsibleSectionOverview.querySelector(".collapsible-content-overview");
                const arrowIcon = collapsibleHeaderOverview.querySelector(".arrow-icon");
                content.classList.toggle("show");
                if (content.classList.contains("show")) {
                    arrowIcon.innerHTML = "&#9660;"; // Down-facing arrow
                } else {
                    arrowIcon.innerHTML = "&#9658;"; // Right-facing arrow
                }
            });

            // Toggle the visibility of the collapsible content when the header is clicked
            collapsibleHeaderProvisions.addEventListener("click", function () {
                const content = collapsibleSectionProvisions.querySelector(".collapsible-content-provisions");
                const arrowIcon = collapsibleHeaderProvisions.querySelector(".arrow-icon");
                if (content.style.display === "block") {
                    content.style.display = "none";
                    arrowIcon.innerHTML = "&#9658;"; // Right-facing arrow
                } else {
                    content.style.display = "block";
                    arrowIcon.innerHTML = "&#9660;"; // Down-facing arrow
                }
            });

            // Toggle the visibility of the collapsible content when the header is clicked
            collapsibleHeaderComparison.addEventListener("click", function () {
                const content = collapsibleSectionComparison.querySelector(".collapsible-content-comparison");
                const arrowIcon = collapsibleHeaderComparison.querySelector(".arrow-icon");
                if (content.style.display === "block") {
                    content.style.display = "none";
                    arrowIcon.innerHTML = "&#9658;"; // Right-facing arrow
                } else {
                    content.style.display = "block";
                    arrowIcon.innerHTML = "&#9660;"; // Down-facing arrow
                }
            });

            // Toggle the visibility of the collapsible content when the header is clicked
            collapsibleHeaderRegulation.addEventListener("click", function () {
                const content = collapsibleSectionRegulation.querySelector(".collapsible-content-regulation");
                const arrowIcon = collapsibleHeaderRegulation.querySelector(".arrow-icon");
                content.classList.toggle("show");
                if (content.classList.contains("show")) {
                    arrowIcon.innerHTML = "▼"; // Down-facing arrow
                } else {
                    arrowIcon.innerHTML = "►"; // Right-facing arrow
                }
            });

            // Toggle the visibility of the collapsible content when the header is clicked
            collapsibleHeaderLaws.addEventListener("click", function () {
                const content = collapsibleSectionLaws.querySelector(".collapsible-content-laws");
                const arrowIcon = collapsibleHeaderLaws.querySelector(".arrow-icon");
                content.classList.toggle("show");
                if (content.classList.contains("show")) {
                    arrowIcon.innerHTML = "&#9660;"; // Down-facing arrow
                } else {
                    arrowIcon.innerHTML = "&#9658;"; // Right-facing arrow
                }
            });

            // Show the content if the button is clicked (for demonstration purposes)
            compareButton.addEventListener("click", function () {
                const content = collapsibleSectionComparison.querySelector(".collapsible-content-comparison");
                const arrowIcon = collapsibleHeaderComparison.querySelector(".arrow-icon");
                content.style.display = "block";
                arrowIcon.innerHTML = "&#9660;"; // Down-facing arrow
            });

            // TOOLTIP CODE
            // Function to show the hover tooltip
            function showHoverTooltip(content, x, y) {
                const hoverTooltip = document.querySelector("#hovertooltip");
                hoverTooltip.innerHTML = content;
                hoverTooltip.style.display = "block"; // Temporarily set to block

                // Use setTimeout to ensure the hover tooltip is rendered before measuring
                setTimeout(() => {
                    const hoverTooltipRect = hoverTooltip.getBoundingClientRect();
                    const mapRect = document.querySelector("#map").getBoundingClientRect();

                    // Initial position
                    let left = x + 5; // Add padding
                    let top = y - 28; // Adjust as needed

                    // Adjust positions based on hover tooltip and map dimensions
                    if (left + hoverTooltipRect.width > mapRect.right) {
                        left = mapRect.right - hoverTooltipRect.width - 5; // Add padding
                    }
                    if (left < mapRect.left) {
                        left = mapRect.left + 5; // Add padding
                    }
                    if (top + hoverTooltipRect.height > mapRect.bottom) {
                        top = mapRect.bottom - hoverTooltipRect.height - 5; // Add padding
                    }
                    if (top < mapRect.top) {
                        top = mapRect.top + 5; // Add padding
                    }

                    // Set the final position
                    hoverTooltip.style.left = `${left}px`;
                    hoverTooltip.style.top = `${top}px`;

                    // Ensure the hover tooltip classes are set correctly
                    hoverTooltip.classList.add("visible");
                    hoverTooltip.classList.remove("hidden");
                }, 0); // Execute after rendering

                hoverTooltip.onclick = function (event) {
                    event.stopPropagation(); // Prevent click event from bubbling up to other elements
                };
            }

            // Function to show the tooltip
            function showTooltip(content, x, y) {
                const tooltip = document.querySelector("#tooltip");
                tooltip.innerHTML = content;
                tooltip.style.opacity = 1;
                tooltip.style.display = "block"; // Temporarily set to block

                // Use setTimeout to ensure the tooltip is rendered before measuring
                setTimeout(() => {
                    const tooltipRect = tooltip.getBoundingClientRect();
                    const mapRect = document.querySelector("#map").getBoundingClientRect();

                    // Initial position
                    let left = x + 5; // Add padding
                    let top = y - 28; // Adjust as needed

                    // Adjust positions based on tooltip and map dimensions
                    if (left + tooltipRect.width > mapRect.right) {
                        left = mapRect.right - tooltipRect.width - 5; // Add padding
                    }
                    if (left < mapRect.left) {
                        left = mapRect.left + 5; // Add padding
                    }
                    if (top + tooltipRect.height > mapRect.bottom) {
                        top = mapRect.bottom - tooltipRect.height - 5; // Add padding
                    }
                    if (top < mapRect.top) {
                        top = mapRect.top + 5; // Add padding
                    }

                    // Set the final position
                    tooltip.style.left = `${left}px`;
                    tooltip.style.top = `${top}px`;

                    // Ensure the tooltip classes are set correctly
                    tooltip.classList.add("visible");
                    tooltip.classList.remove("hidden");

                    // Close button functionality
                    const closeButton = tooltip.querySelector(".close");
                    if (closeButton) {
                        closeButton.onclick = function (event) {
                            event.stopPropagation(); // Prevent the event from bubbling up
                            hideTooltip();
                        };
                    }
                }, 0); // Execute after rendering

                tooltip.onclick = function (event) {
                    event.stopPropagation(); // Prevent click event from bubbling up to other elements
                };
            }

            function hideTooltip() {
                const tooltip = document.querySelector("#tooltip");
                tooltip.style.display = "none"; // Hide the tooltip
                tooltip.style.opacity = 0; // Fade out if needed
                tooltip.classList.remove("visible");
                tooltip.classList.add("hidden");
            }

            function hideHoverTooltip() {
                const hoverTooltip = document.querySelector("#hovertooltip");
                hoverTooltip.style.display = "none"; // Hide the hover tooltip
                hoverTooltip.classList.remove("visible");
                hoverTooltip.classList.add("hidden");
            }
            /*
    // Function to setup tooltips
    function setupTooltips() {
      stateGroups.coverageGroup.selectAll("path")
        .on("mouseover", function(event, d) {
          const tooltipText = d.properties.name; // Example: state name
          const x = event.pageX;
          const y = event.pageY;
          showTooltip(tooltipText, x, y);
        })
        .on("mouseout", hideTooltip);
    }
*/
        </script>
    </body>
</html>
