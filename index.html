<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Genetic Privacy Laws in the US</title>

  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
  <style>
    body,
    html {
      height: 100%;
      margin: 0;
      font-family: 'Montserrat', sans-serif;
    }

    #map {
      height: 100vh;
      width: calc(100vw - 350px);
      /* Adjusted map width calculation */
      position: absolute;
      right: 0;
      top: 0;
      overflow: hidden;
      /* Prevent overflow */
    }

    .sidebar {
      width: 350px;
      height: 100vh;
      position: absolute;
      left: 0;
      top: 0;
      background: white;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: width 0.3s ease;
      /* Add transition for width */
    }

    .sidebar-header {
      padding: 15px 0 15px 15px;
      /* Adjusted padding */
      background: #007BFF;
      color: white;
      text-align: left;
      /* Changed text alignment */
      font-size: 18px;
      font-weight: bold;
    }

    .layer-control {
      margin-top: 20px;
      padding-left: 15px;
      /* Added padding to separate from collapse button */
    }

    .layer-control input {
      margin-right: 5px;
    }

    .tooltip {
      position: absolute;
      text-align: center;
      padding: 5px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 1px solid #ccc;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }

    .highlighted {
      stroke: yellow;
      stroke-width: 2px;
    }
  </style>
</head>

<body>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">Genetic Privacy Laws in the USA</div>
    <div class="sidebar-content">
      <!-- Layer control -->
      <div class="layer-control">
        <div>
          <input type="radio" id="coverageLayerToggle" name="layer" value="coverage">
          <label for="coverageLayerToggle">Extent of Coverage</label>
        </div>
        <div>
          <input type="radio" id="lifeLayerToggle" name="layer" value="life" checked>
          <label for="lifeLayerToggle">Life</label>
        </div>
        <div>
          <input type="radio" id="disabilityLayerToggle" name="layer" value="disability">
          <label for="disabilityLayerToggle">Disability</label>
        </div>
        <div>
          <input type="radio" id="ltcLayerToggle" name="layer" value="ltc">
          <label for="ltcLayerToggle">LTC</label>
        </div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <!-- Tooltip -->
  <div class="tooltip" id="tooltip"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js" integrity="sha512-vc58qvvBdrDR4etbxMdlTt4GBQk1qjvyORR2nrsPsFPyrs+/u5c3+1Ct6upOgdZoIl7eq6k3a1UPDSNAQi/32A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.js"></script>

  <script>
    const width = window.innerWidth * 0.75;
    const height = window.innerHeight;

    const svg = d3.select("#map")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    const projection = d3.geoAlbersUsa()
      .translate([width / 2, height / 2])
      .scale(1000);

    const path = d3.geoPath(projection);

    const tooltip = d3.select("#tooltip");

    Promise.all([
      d3.csv("data/genetic-privacy.csv"),
      d3.json("data/states-10m.json")
    ]).then(makeMap).catch(error => console.error('Error loading data:', error));

    let lifeGroup, disabilityGroup, ltcGroup, coverageGroup;

    function makeMap([dnaPrivacy, states]) {

      const lifeData = checkDataForStates(dnaPrivacy, 'Life');
      const disabilityData = checkDataForStates(dnaPrivacy, 'Disability');
      const ltcData = checkDataForStates(dnaPrivacy, 'LTC');

      lifeGroup = svg.append("g").attr("id", "lifeLayer");
      disabilityGroup = svg.append("g").attr("id", "disabilityLayer");
      ltcGroup = svg.append("g").attr("id", "ltcLayer");
      coverageGroup = svg.append("g").attr("id", "coverageLayer"); // Add a new group for the coverage layer

      drawLayer(lifeGroup, states, lifeData, "blue");
      drawLayer(disabilityGroup, states, disabilityData, "blue");
      drawLayer(ltcGroup, states, ltcData, "blue");
      drawCoverageLayer(coverageGroup, states, groupAndCountEntriesForStates(dnaPrivacy));

      const zoom = d3.zoom().scaleExtent([0, 8]).on("zoom", zoomed);
      svg.call(zoom);

      function zoomed(event) {
        svg.selectAll("g").attr("transform", event.transform);
      }

      const bounds = path.bounds(topojson.feature(states, states.objects.states));
      const initialScale = Math.min(width / (bounds[1][0] - bounds[0][0]), height / (bounds[1][1] - bounds[0][1])) * 0.9;
      svg.call(zoom.transform, d3.zoomIdentity.translate(width / 2, height / 2).scale(initialScale).translate(-width / 2, -height / 2));

      document.querySelectorAll('input[name="layer"]').forEach(input => {
        input.addEventListener("change", function() {
          if (this.value === "life") {
            lifeGroup.style("visibility", "visible");
            disabilityGroup.style("visibility", "hidden");
            ltcGroup.style("visibility", "hidden");
            coverageGroup.style("visibility", "hidden"); // Hide the coverage layer
          } else if (this.value === "disability") {
            lifeGroup.style("visibility", "hidden");
            disabilityGroup.style("visibility", "visible");
            ltcGroup.style("visibility", "hidden");
            coverageGroup.style("visibility", "hidden"); // Hide the coverage layer
          } else if (this.value === "ltc") {
            lifeGroup.style("visibility", "hidden");
            disabilityGroup.style("visibility", "hidden");
            ltcGroup.style("visibility", "visible");
            coverageGroup.style("visibility", "hidden"); // Hide the coverage layer
          } else if (this.value === "coverage") {
            lifeGroup.style("visibility", "hidden");
            disabilityGroup.style("visibility", "hidden");
            ltcGroup.style("visibility", "hidden");
            coverageGroup.style("visibility", "visible"); // Show the coverage layer
          }
        });
      });

      // Show coverage layer by default
      coverageGroup.style("visibility", "visible");

      // Hide these layers
      lifeGroup.style("visibility", "hidden");
      disabilityGroup.style("visibility", "hidden");
      ltcGroup.style("visibility", "hidden");
    }

    function drawLayer(layerGroup, states, data, color) {
      layerGroup.selectAll("path")
        .data(topojson.feature(states, states.objects.states).features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("fill", d => {
          const stateData = data.find(state => state.name === d.properties.name);
          return stateData && stateData.hasData ? color : "gray";
        })
        .attr("stroke", "white")
        .attr("stroke-width", 0.5)
        .on("mouseover", function(event, d) {
          d3.select(this).classed("highlighted", true).raise(); // Add highlighted class and bring to front on mouseover
          tooltip.transition().duration(200).style("opacity", .9);
          tooltip.html(d.properties.name);
        })
        .on("mousemove", function(event) {
          tooltip.style("left", (event.pageX + 5) + "px")
            .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function() {
          d3.select(this).classed("highlighted", false); // Remove highlighted class on mouseout
          tooltip.transition().duration(500).style("opacity", 0);
        });
    }

    function drawCoverageLayer(layerGroup, states, data) {
      const colorScale = d3.scaleLinear()
        .domain([1, 2, 3])
        .range(["lightblue", "blue", "darkblue"]);

      const tooltip = d3.select("#tooltip");

      layerGroup.selectAll("path")
        .data(topojson.feature(states, states.objects.states).features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("fill", d => {
          const stateData = data.find(state => state.name === d.properties.name);
          return stateData ? colorScale(stateData.count) : "gray";
        })
        .attr("stroke", "white")
        .attr("stroke-width", 0.5)
        .on("mouseover", function(event, d) {
          d3.select(this).classed("highlighted", true).raise(); // Add highlighted class and bring to front on mouseover
          tooltip.transition().duration(200).style("opacity", .9);
          tooltip.html(d.properties.name);
        })
        .on("mousemove", function(event) {
          tooltip.style("left", (event.pageX + 5) + "px")
            .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function() {
          d3.select(this).classed("highlighted", false); // Remove highlight from state border
          tooltip.transition().duration(500).style("opacity", 0);
        });
    }

    function checkDataForStates(data, field) {
      const stateDataMap = {};
      data.forEach(row => {
        const state = row.State;
        if (!stateDataMap[state]) {
          stateDataMap[state] = {
            name: state,
            hasData: false
          };
        }
        if (row[field]) {
          stateDataMap[state].hasData = true;
        }
      });
      return Object.values(stateDataMap);
    }

    function groupAndCountEntriesForStates(data) {
      const stateDataMap = {};

      data.forEach(row => {
        const state = row.State;
        if (!stateDataMap[state]) {
          stateDataMap[state] = {
            name: state,
            life: false,
            disability: false,
            ltc: false
          };
        }
        if (row.Life) stateDataMap[state].life = true;
        if (row.Disability) stateDataMap[state].disability = true;
        if (row.LTC) stateDataMap[state].ltc = true;
      });

      const result = Object.values(stateDataMap).map(state => ({
        name: state.name,
        count: [state.life, state.disability, state.ltc].filter(Boolean).length
      }));

      return result;
    }
  </script>
</body>

</html>